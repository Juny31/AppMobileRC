
<!DOCTYPE html>
<html lang="fr" data-theme="cupertino">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Regards Crois√©s ‚Äî App</title>
  <meta name="theme-color" content="#f5f5f7"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#f5f5f7; --card:#ffffff; --text:#1d1d1f; --muted:#6e6e73; --line:#d2d2d7; --accent:#0071e3;
      --radius:24px; --space-sm:12px; --space-md:20px; --space-lg:32px; --space-xl:48px; --space-2xl:72px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.56}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(180%) blur(16px);background:color-mix(in srgb, var(--bg) 70%, transparent);border-bottom:1px solid var(--line)}
    .container{max-width:1200px;margin:auto;padding:0 var(--space-lg)}
    .brand{display:flex;align-items:center;justify-content:space-between;padding:18px 0}
    .brand-left{display:flex;align-items:center;gap:var(--space-sm)}
    .logo{width:40px;height:40px;border-radius:12px}
    .title h1{margin:0;font-size:20px;letter-spacing:.2px}
    .bar{display:flex;gap:10px;padding:12px 0 18px;border-top:1px solid var(--line)}
    .seg{appearance:none;border:1px solid var(--line);border-radius:14px;background:var(--card);padding:10px 14px;font-weight:600;color:var(--text)}
    .seg[aria-selected="true"]{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent)}
    main{padding: var(--space-xl) 0}
    .grid{display:grid;gap:var(--space-lg)}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--space-lg);box-shadow:0 1px 2px rgba(0,0,0,.06),0 12px 40px rgba(0,0,0,.08)}
    input,textarea,select{width:100%;padding:14px;border-radius:16px;border:1px solid var(--line);background:var(--bg);color:var(--text)}
    textarea{min-height:120px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer;border:1px solid var(--line);background:var(--card);padding:12px 18px;border-radius:999px;font-weight:700}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn-danger{background:#e11900;border-color:#e11900;color:#fff}
    .pill{border:1px solid var(--line);border-radius:999px;padding:8px 12px}
    .status{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px}
    .muted{color:#6e6e73}
    .hidden{display:none}
    .progress{height:12px;background:#e9e9ed;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
    .progress>div{height:100%;background:var(--accent)}
    .kanban{display:grid;gap:var(--space-md)}
    @media(min-width:980px){.kanban{grid-template-columns:repeat(3,1fr)}}
    .col{border:1px dashed var(--line);border-radius:18px;padding:var(--space-md);min-height:180px;background:var(--card)}
    .kan-card{border:1px solid var(--line);border-radius:16px;padding:12px;background:var(--bg)}
    footer{padding: var(--space-xl) 0; border-top:1px solid var(--line); color:#6e6e73; margin-top: var(--space-xl)}
    #toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);border:1px solid var(--line);padding:10px 14px;border-radius:999px;opacity:0;transition:.2s}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="brand-left">
        <img src="media/logo.svg" class="logo" alt="logo">
        <div class="title"><h1>Regards Crois√©s ‚Äî App</h1></div>
      </div>
      <div class="actions">
        <a class="btn" href="index.html">Accueil</a>
        <button id="btn-theme" class="btn">Cupertino</button>
      </div>
    </div>
    <div class="container bar" role="tablist">
      <button class="seg" aria-selected="true" data-tab="home">Accueil</button>
      <button class="seg" data-tab="articles">Articles</button>
      <button class="seg" data-tab="episodes">Podcasts</button>
      <button class="seg" data-tab="tasks">T√¢ches</button>
      <button class="seg" data-tab="contacts">Contacts</button>
      <button class="seg" data-tab="settings">R√©glages</button>
    </div>
  </header>

  <main class="container">
    <section id="tab-home">
      <div class="grid">
        <div class="card">
          <h3>Th√®me du mois</h3>
          <form id="theme-form">
            <label>Titre<input id="theme-title" placeholder="ex: R√©silience ‚Äî Des voix qui s‚Äô√©l√®vent"></label>
            <label>Description<textarea id="theme-desc" placeholder="Angle √©ditorial du mois‚Ä¶"></textarea></label>
            <div class="actions"><button class="btn btn-primary" type="submit">Enregistrer</button></div>
          </form>
          <p class="muted" id="theme-preview"></p>
        </div>
        <div class="card">
          <h3>Guidelines visuelles</h3>
          <p class="muted">Espaces g√©n√©reux, cartes a√©r√©es, accent bleu #0071e3, bordures #d2d2d7, typographie nette.</p>
        </div>
      </div>
    </section>

    <section id="tab-articles" class="hidden">
      <div class="card">
        <h3>Articles</h3>
        <form id="article-form">
          <input type="hidden" id="article-id">
          <label>Titre<input id="article-title" required></label>
          <label>Tags<input id="article-tags" placeholder="soci√©t√©, conflit‚Ä¶"></label>
          <label>R√©sum√©<textarea id="article-summary"></textarea></label>
          <div class="actions"><button type="submit" class="btn btn-primary">Enregistrer</button><button type="button" id="article-reset" class="btn">Annuler</button></div>
        </form>
      </div>
      <div class="actions" style="margin:14px 0"><input id="article-search" placeholder="Recherche‚Ä¶"><button id="article-clear" class="btn">Vider la liste</button></div>
      <div id="article-list" class="grid"></div>
    </section>

    <section id="tab-episodes" class="hidden">
      <div class="card">
        <h3>Podcasts</h3>
        <form id="ep-form">
          <input type="hidden" id="ep-id">
          <label>Titre<input id="ep-title" required></label>
          <label>Invit√©(s)<input id="ep-guests"></label>
          <label>Th√®me<input id="ep-theme"></label>
          <label>Statut<select id="ep-status"><option>Brouillon</option><option>Publi√©</option></select></label>
          <label>Date<input id="ep-date" type="date"></label>
          <label>Image (URL)<input id="ep-image" type="url"></label>
          <label>Audio (URL)<input id="ep-audio" type="url"></label>
          <label>Lien m√©dia<input id="ep-link" type="url"></label>
          <div class="actions"><button type="submit" class="btn btn-primary">Enregistrer</button><button type="button" id="ep-reset" class="btn">Annuler</button></div>
        </form>
      </div>
      <div class="actions" style="margin:14px 0"><input id="ep-search" placeholder="Recherche‚Ä¶"><button id="ep-clear" class="btn">Vider la liste</button></div>
      <div id="ep-list" class="grid"></div>
    </section>

    <section id="tab-tasks" class="hidden">
      <div class="card">
        <h3>T√¢ches</h3>
        <form id="task-form">
          <input type="hidden" id="task-id">
          <label>Titre<input id="task-title" required placeholder="ex: Contacter journaliste‚Ä¶"></label>
          <label>Statut<select id="task-status"><option>√Ä faire</option><option>En cours</option><option>Termin√©</option></select></label>
          <label>Priorit√©<select id="task-priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></label>
          <label>Assign√©e(s) üë•<select id="task-assignees" multiple size="5" title="Ctrl/Cmd + clic pour multi-s√©lection"></select></label>
          <div class="actions">
            <input id="team-new" placeholder="Ajouter un pr√©nom (ex: Alex)" style="max-width:320px">
            <button id="team-add" type="button" class="btn">Ajouter au groupe</button>
          </div>
          <label>√âch√©ance<input id="task-due" type="date"></label>
          <label>Notes<textarea id="task-notes"></textarea></label>
          <div class="actions"><button type="submit" class="btn btn-primary">Enregistrer</button><button type="button" id="task-reset" class="btn">Annuler</button></div>
        </form>
      </div>

      <div class="card">
        <div class="actions" style="justify-content:space-between;align-items:center">
          <h3>Statistiques</h3>
          <div class="actions"><button id="view-list" class="btn">Vue Liste</button><button id="view-kanban" class="btn">Vue Kanban</button></div>
        </div>
        <div class="actions" style="gap:14px;margin-bottom:10px">
          <span class="pill">Total <b id="stat-task-total">0</b></span>
          <span class="pill">Termin√©es <b id="stat-task-done">0</b></span>
          <span class="pill">Haute priorit√© <b id="stat-task-high">0</b></span>
          <span class="pill">En retard <b id="stat-task-late">0</b></span>
          <span class="pill">‚â§ 7 jours <b id="stat-task-week">0</b></span>
        </div>
        <div class="progress"><div id="task-progress" style="width:0%"></div></div>
      </div>

      <div class="actions" style="margin:14px 0">
        <input id="task-search" placeholder="Recherche titre / notes‚Ä¶">
        <select id="task-sort">
          <option value="updated">Tri : modifi√© r√©cemment</option>
          <option value="due">Tri : par √©ch√©ance</option>
          <option value="priority">Tri : par priorit√©</option>
        </select>
        <button id="task-clear" class="btn">Vider la liste</button>
      </div>

      <div id="task-list" class="grid"></div>
      <div id="task-kanban" class="kanban hidden">
        <div class="col" data-col="√Ä faire"><h4>√Ä faire</h4><div class="drop" data-status="√Ä faire"></div></div>
        <div class="col" data-col="En cours"><h4>En cours</h4><div class="drop" data-status="En cours"></div></div>
        <div class="col" data-col="Termin√©"><h4>Termin√©</h4><div class="drop" data-status="Termin√©"></div></div>
      </div>
    </section>

    <section id="tab-contacts" class="hidden">
      <div class="card">
        <h3>Contacts</h3>
        <form id="contact-form">
          <input type="hidden" id="contact-id">
          <label>Nom<input id="contact-name" required></label>
          <label>Type<select id="contact-type"><option>Organisation</option><option>Personnalit√©</option></select></label>
          <label>Statut<select id="contact-status"><option>En contact</option><option>√Ä contacter</option><option>Termin√©</option><option>En attente</option></select></label>
          <label>Priorit√©<select id="contact-priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></label>
          <label>Email<input id="contact-email" type="email"></label>
          <label>R√©seaux<input id="contact-social"></label>
          <div class="actions"><button type="submit" class="btn btn-primary">Enregistrer</button><button type="button" id="contact-reset" class="btn">Annuler</button></div>
        </form>
      </div>
      <div class="card">
        <h3>R√©partition</h3>
        <div class="actions" style="gap:14px;margin-bottom:10px">
          <span class="pill">En contact <b id="st-contacted">0</b></span>
          <span class="pill">√Ä contacter <b id="st-tocontact">0</b></span>
          <span class="pill">Termin√© <b id="st-done">0</b></span>
          <span class="pill">En attente <b id="st-pending">0</b></span>
        </div>
        <div id="contact-bars" class="grid"></div>
      </div>
      <div class="actions" style="margin:14px 0"><input id="contact-search" placeholder="Recherche‚Ä¶"><button id="contact-clear" class="btn">Vider la liste</button></div>
      <div id="contact-list" class="grid"></div>
    </section>

    <section id="tab-settings" class="hidden">
      <div class="card">
        <h3>√âquipe (assignation par pr√©noms)</h3>
        <div class="actions">
          <input id="team-input" placeholder="Ajouter un pr√©nom (ex: Alex)" style="max-width:360px">
          <button id="team-add-main" class="btn btn-primary" type="button">Ajouter</button>
        </div>
        <div id="team-list" class="actions" style="margin-top:12px"></div>
      </div>
      <div class="card">
        <h3>Export PDF</h3>
        <p class="muted">Logo, stats, √©ch√©ances, r√©capitulatif des t√¢ches termin√©es.</p>
        <button id="btn-pdf" class="btn btn-primary">Exporter le rapport PDF</button>
      </div>
      <div class="card">
        <h3>Maintenance</h3>
        <div class="actions">
          <button id="btn-demo" class="btn">Recr√©er donn√©es d√©mo</button>
          <button id="btn-reset" class="btn btn-danger">R√©initialiser tout</button>
        </div>
      </div>
    </section>
  </main>

  <button id="btn-install" class="btn btn-primary" style="position:fixed;bottom:18px;right:18px;display:none">Installer l‚Äôapp</button>
  <div id="toast" role="status" aria-live="polite"></div>
  <footer class="container"><small>¬© <span id="year"></span> Regards Crois√©s</small></footer>

  <script>
    const KEY='rc-data-cupertino-air-v9', THEME_KEY='rc-theme', $=s=>document.querySelector(s);
    const State={data:{articles:[],episodes:[],tasks:[],contacts:[],theme:{title:'',desc:''},team:[]},
      save(){localStorage.setItem(KEY,JSON.stringify(this.data))},
      load(){const r=localStorage.getItem(KEY);this.data=r?JSON.parse(r):{articles:[],episodes:[],tasks:[],contacts:[],theme:{title:'',desc:''},team:['Jude','Grace']}}};

    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); const map={cupertino:'Cupertino', 'cupertino-dark':'Cupertino (sombre)'}; document.getElementById('btn-theme').textContent=map[t]||t; localStorage.setItem(THEME_KEY,t); }
    function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme')||'cupertino'; const order=['cupertino','cupertino-dark']; const next=order[(order.indexOf(cur)+1)%order.length]; applyTheme(next); }
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function stringifyTags(v){ return (v||'').split(',').map(t=>t.trim()).filter(Boolean); }
    function matches(q, ...f){ q=q.toLowerCase(); return f.some(x=>(x||'').toLowerCase().includes(q)); }
    function selectTab(name){ document.querySelectorAll('.seg').forEach(b=>b.setAttribute('aria-selected', String(b.dataset.tab===name))); document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden')); document.querySelector('#tab-'+name).classList.remove('hidden'); }
    function refreshAssigneeOptions(){ const sel=document.getElementById('task-assignees'); if(!sel) return; const selected=Array.from(sel.selectedOptions).map(o=>o.value); sel.innerHTML=(State.data.team||[]).map(n=>`<option value="${n}">${n}</option>`).join(''); selected.forEach(v=>{ const o=[...sel.options].find(x=>x.value===v); if(o) o.selected=true; }); }

    // Articles
    function renderArticles(list=State.data.articles){
      const q=$('#article-search')?.value?.trim().toLowerCase()||'';
      const filtered=q?list.filter(a=>matches(q,a.title,a.summary,(a.tags||[]).join(','))):list;
      const wrap=$('#article-list'); if(!wrap) return; wrap.innerHTML='';
      if(!filtered.length){ wrap.innerHTML='<div class="card muted">Aucun article.</div>'; return; }
      for(const a of filtered){
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `<h3>${a.title}</h3><p class="muted">${a.summary||''}</p>
          <div class="actions" style="margin:8px 0">${(a.tags||[]).map(t=>`<span class="pill">#${t}</span>`).join('')}</div>
          <div class="actions"><button class="btn" data-edit="${a.id}">√âditer</button><button class="btn btn-danger" data-del="${a.id}">Supprimer</button></div>`;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>editArticle(b.dataset.edit));
      wrap.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delArticle(b.dataset.del));
    }
    function editArticle(id){ const a=State.data.articles.find(x=>x.id===id); if(!a) return; $('#article-id').value=a.id; $('#article-title').value=a.title; $('#article-tags').value=(a.tags||[]).join(', '); $('#article-summary').value=a.summary||''; window.scrollTo({top:0,behavior:'smooth'}); selectTab('articles'); }
    function delArticle(id){ if(!confirm('Supprimer cet article ?')) return; State.data.articles=State.data.articles.filter(x=>x.id!==id); State.save(); renderArticles(); toast('Article supprim√©'); }

    // Episodes
    function renderEpisodes(list=State.data.episodes){
      const q=$('#ep-search')?.value?.trim().toLowerCase()||'';
      const filtered=q?list.filter(e=>matches(q,e.title,e.guests,e.theme,e.status,e.date)):list;
      const wrap=$('#ep-list'); if(!wrap) return; wrap.innerHTML='';
      if(!filtered.length){ wrap.innerHTML='<div class="card muted">Aucun √©pisode.</div>'; return; }
      for(const e of filtered){
        const el=document.createElement('div'); el.className='card';
        const img=e.image?`<img src="${e.image}" alt="visuel" style="width:100%;border-radius:20px;border:1px solid var(--line);margin-bottom:10px">`:'';
        const audio=e.audio?`<audio controls style="width:100%;margin-top:8px"><source src="${e.audio}"></audio>`:'';
        el.innerHTML=`${img}<h3>${e.title}</h3>
          <p class="muted">${e.status||'Brouillon'}${e.date?(' ‚Ä¢ '+e.date):''} ‚Ä¢ Invit√©(s): ${e.guests||'‚Äî'} ‚Ä¢ Th√®me: ${e.theme||'‚Äî'}</p>
          ${e.link?`<a class="btn" href="${e.link}" target="_blank" rel="noopener">√âcouter</a>`:''}
          ${audio}
          <div class="actions" style="margin-top:10px"><button class="btn" data-ep-edit="${e.id}">√âditer</button><button class="btn btn-danger" data-ep-del="${e.id}">Supprimer</button></div>`;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll('[data-ep-edit]').forEach(b=>b.onclick=()=>editEpisode(b.dataset.epEdit));
      wrap.querySelectorAll('[data-ep-del]').forEach(b=>b.onclick=()=>delEpisode(b.dataset.epDel));
    }
    function editEpisode(id){ const e=State.data.episodes.find(x=>x.id===id); if(!e) return; $('#ep-id').value=e.id; $('#ep-title').value=e.title; $('#ep-guests').value=e.guests||''; $('#ep-theme').value=e.theme||''; $('#ep-link').value=e.link||''; $('#ep-image').value=e.image||''; $('#ep-audio').value=e.audio||''; $('#ep-status').value=e.status||'Brouillon'; $('#ep-date').value=e.date||''; window.scrollTo({top:0,behavior:'smooth'}); selectTab('episodes'); }
    function delEpisode(id){ if(!confirm('Supprimer cet √©pisode ?')) return; State.data.episodes=State.data.episodes.filter(x=>x.id!==id); State.save(); renderEpisodes(); toast('√âpisode supprim√©'); }

    // Tasks
    function computeTaskStats(){
      const t=State.data.tasks;
      const total=t.length, done=t.filter(x=>x.status==='Termin√©').length, high=t.filter(x=>x.priority==='Haute').length;
      const now=new Date(), weekAhead=new Date(); weekAhead.setDate(now.getDate()+7);
      const late=t.filter(x=>x.status!=='Termin√©' && x.due && new Date(x.due) < now).length;
      const week=t.filter(x=>x.status!=='Termin√©' && x.due && new Date(x.due) <= weekAhead && new Date(x.due)>=now).length;
      $('#stat-task-total').textContent=total; $('#stat-task-done').textContent=done; $('#stat-task-high').textContent=high; $('#stat-task-late').textContent=late; $('#stat-task-week').textContent=week;
      const pct = total? Math.round((done/total)*100):0; $('#task-progress').style.width=pct+'%'; $('#task-progress').title=pct+'%';
    }
    function sortTasks(list){
      const mode = $('#task-sort').value; const priRank = {Haute:0,Moyenne:1,Basse:2};
      if(mode==='due') return list.slice().sort((a,b)=> (a.due||'').localeCompare(b.due||''));
      if(mode==='priority') return list.slice().sort((a,b)=> (priRank[a.priority]??9)-(priRank[b.priority]??9));
      return list.slice();
    }
    function renderTasks(list=State.data.tasks){
      computeTaskStats();
      const q=$('#task-search')?.value?.trim().toLowerCase()||'';
      const filtered=(q?list.filter(t=>matches(q,t.title,t.notes,(t.assignees||[]).join(','))):list);
      const sorted=sortTasks(filtered);
      const wrap=$('#task-list'); if(!wrap) return; wrap.innerHTML='';
      if(!sorted.length){ wrap.innerHTML='<div class="card muted">Aucune t√¢che.</div>'; return; }
      for(const t of sorted){
        const el=document.createElement('div'); el.className='card'; el.draggable=true; el.dataset.id=t.id;
        const who=t.assignees||[]; const due=t.due?` ‚Ä¢ √âch√©ance: ${t.due}`:'';
        const overdue = t.status!=='Termin√©' && t.due && (new Date(t.due) < new Date());
        el.innerHTML = `<h3>${t.title}</h3>
          <div class="actions" style="margin:8px 0">
            <span class="status">${t.status}</span>
            <span class="status">${t.priority}</span>
            ${who.length?who.map(n=>`<span class="pill">${n}</span>`).join(''): '<span class="pill">‚Äî</span>'}
          </div>
          <p class="muted">${t.notes||''}${due}</p>
          <div class="actions"><button class="btn" data-task-edit="${t.id}">√âditer</button><button class="btn btn-danger" data-task-del="${t.id}">Supprimer</button></div>`;
        if(overdue) el.style.outline='2px solid #e11900';
        wrap.appendChild(el);
      }
      wrap.querySelectorAll('[data-task-edit]').forEach(b=>b.onclick=()=>editTask(b.dataset.taskEdit));
      wrap.querySelectorAll('[data-task-del]').forEach(b=>b.onclick=()=>delTask(b.dataset.taskDel));
      wrap.querySelectorAll('#task-list .card').forEach(c=>{ c.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', c.dataset.id); }); });
    }
    function buildKanban(){
      const areas = document.querySelectorAll('#task-kanban .drop');
      areas.forEach(a=>{
        a.innerHTML=''; const status=a.dataset.status;
        const items = State.data.tasks.filter(t=>t.status===status);
        for(const t of items){
          const k=document.createElement('div'); k.className='kan-card'; k.draggable=true; k.dataset.id=t.id;
          const who=t.assignees||[];
          k.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><b>${t.title}</b><span class="status">${t.priority}</span></div>
          <div class="muted">${(who.join(', ')||'‚Äî')} ${t.due?(' ‚Ä¢ '+t.due):''}</div>`;
          k.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id); });
          a.appendChild(k);
        }
        a.addEventListener('dragover', e=>e.preventDefault());
        a.addEventListener('drop', e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData('text/plain');
          const idx=State.data.tasks.findIndex(x=>x.id===id); if(idx<0) return;
          const prev=State.data.tasks[idx];
          State.data.tasks[idx]={...prev, status:status, completedAt:(status==='Termin√©' ? (prev.completedAt||new Date().toISOString()) : (prev.completedAt||undefined))};
          State.save(); renderTasks(); buildKanban(); toast('Statut mis √† jour');
        });
      });
    }
    function editTask(id){
      const t=State.data.tasks.find(x=>x.id===id); if(!t) return;
      $('#task-id').value=t.id; $('#task-title').value=t.title; $('#task-status').value=t.status; $('#task-priority').value=t.priority; $('#task-notes').value=t.notes||''; $('#task-due').value=t.due||'';
      refreshAssigneeOptions(); const sel=$('#task-assignees'); [...sel.options].forEach(o=>o.selected=(t.assignees||[]).includes(o.value));
      window.scrollTo({top:0,behavior:'smooth'}); selectTab('tasks');
    }
    function delTask(id){ if(!confirm('Supprimer cette t√¢che ?')) return; State.data.tasks=State.data.tasks.filter(x=>x.id!==id); State.save(); renderTasks(); buildKanban(); toast('T√¢che supprim√©e'); }

    // Contacts
    function computeContactStats(){
      const c=State.data.contacts, by=s=>c.filter(x=>x.status===s).length;
      $('#st-contacted').textContent=by('En contact'); $('#st-tocontact').textContent=by('√Ä contacter'); $('#st-done').textContent=by('Termin√©'); $('#st-pending').textContent=by('En attente');
      const total=c.length||1, labels=[['En contact','st-contacted'],['√Ä contacter','st-tocontact'],['Termin√©','st-done'],['En attente','st-pending']];
      const wrap=document.getElementById('contact-bars'); if(!wrap) return; wrap.innerHTML='';
      labels.forEach(([label, id])=>{
        const val = parseInt(document.getElementById(id).textContent)||0;
        const pct = Math.round((val/total)*100);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`<div style="display:flex;justify-content:space-between"><span class="status">${label}</span><b>${val}</b></div>
          <div class="progress" style="margin-top:10px"><div style="width:${pct}%"></div></div>`;
        wrap.appendChild(card);
      });
    }
    function renderContacts(list=State.data.contacts){
      computeContactStats();
      const q=$('#contact-search')?.value?.trim().toLowerCase()||'';
      const filtered=q?list.filter(c=>matches(q,c.name,c.email,c.social)):list;
      const wrap=$('#contact-list'); if(!wrap)return; wrap.innerHTML='';
      if(!filtered.length){ wrap.innerHTML='<div class="card muted">Aucun contact.</div>'; return; }
      for(const c of filtered){
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<h3>${c.name}</h3>
          <div class="actions" style="margin:8px 0">
            <span class="status">${c.status}</span>
            <span class="status">${c.type}</span>
            <span class="status">${c.priority}</span>
          </div>
          <p class="muted">${c.email||''} ${c.social?('‚Ä¢ '+c.social):''}</p>
          <div class="actions"><button class="btn" data-contact-edit="${c.id}">√âditer</button><button class="btn btn-danger" data-contact-del="${c.id}">Supprimer</button></div>`;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll('[data-contact-edit]').forEach(b=>b.onclick=()=>editContact(b.dataset.contactEdit));
      wrap.querySelectorAll('[data-contact-del]').forEach(b=>b.onclick=()=>delContact(b.dataset.contactDel));
    }
    function editContact(id){ const c=State.data.contacts.find(x=>x.id===id); if(!c) return; $('#contact-id').value=c.id; $('#contact-name').value=c.name; $('#contact-type').value=c.type; $('#contact-status').value=c.status; $('#contact-priority').value=c.priority; $('#contact-email').value=c.email||''; $('#contact-social').value=c.social||''; window.scrollTo({top:0,behavior:'smooth'}); selectTab('contacts'); }
    function delContact(id){ if(!confirm('Supprimer ce contact ?')) return; State.data.contacts=State.data.contacts.filter(x=>x.id!==id); State.save(); renderContacts(); renderTasks(); buildKanban(); toast('Contact supprim√©'); }

    // Theme
    function updateThemePreview(){ const t=State.data.theme||{title:'',desc:''}; $('#theme-title').value=t.title||''; $('#theme-desc').value=t.desc||''; $('#theme-preview').textContent=t.title?(t.title+' ‚Äî '+(t.desc||'')):'Aucun th√®me d√©fini.'; }

    // PDF
    async function ensureJsPdf(){
      if(!window.jspdf){ await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
      if(!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF indisponible');
      if(!window.jspdfAutoTable){ await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
    }
    async function exportPDF(){
      try{ await ensureJsPdf(); }catch(e){ alert('Impossible de charger jsPDF.'); return; }
      const { jsPDF } = window.jspdf;
      async function dataURL(url){ const res=await fetch(url); const b=await res.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b); }); }
      const logo = await dataURL('media/logo.svg');
      const doc = new jsPDF({ unit:'pt', format:'a4' }); const pad=48; let y=pad;
      doc.setFillColor(245,245,247); doc.rect(0,0,doc.internal.pageSize.getWidth(),72,'F');
      try{ doc.addImage(logo,'SVG', pad, 20, 32, 32); }catch(_){}
      doc.setFontSize(16); doc.text('Regards Crois√©s ‚Äî Rapport', pad+44, 36);
      doc.setFontSize(10); doc.setTextColor(110,110,115); doc.text(new Date().toLocaleString(), pad+44, 54);
      doc.setTextColor(0); y = 96;

      const theme = State.data.theme || {title:'',desc:''};
      doc.setDrawColor(210,210,215); doc.roundedRect(pad,y,523,84,12,12);
      doc.setFontSize(12); doc.text('Th√®me du mois', pad+14, y+22);
      doc.setFontSize(14); doc.text(theme.title||'‚Äî', pad+14, y+44);
      doc.setFontSize(11); doc.setTextColor(110,110,115); doc.text((theme.desc||'‚Äî').substring(0,140), pad+14, y+64);
      doc.setTextColor(0); y += 108;

      const t=State.data.tasks, total=t.length, done=t.filter(x=>x.status==='Termin√©').length, high=t.filter(x=>x.priority==='Haute').length;
      const now=new Date(), weekAhead=new Date(); weekAhead.setDate(now.getDate()+7);
      const late=t.filter(x=>x.status!=='Termin√©' && x.due && new Date(x.due) < now).length;
      const week=t.filter(x=>x.status!=='Termin√©' && x.due && new Date(x.due) <= weekAhead && new Date(x.due)>=now).length;
      const pct = total? Math.round((done/total)*100):0;
      doc.setDrawColor(210,210,215); doc.roundedRect(pad,y,523,96,12,12);
      doc.setFontSize(12); doc.text('T√¢ches ‚Äî Statistiques', pad+14, y+22);
      doc.setFontSize(11);
      doc.text(`Total: ${total}`, pad+14, y+44); doc.text(`Termin√©es: ${done}`, pad+128, y+44); doc.text(`Haute priorit√©: ${high}`, pad+270, y+44);
      doc.text(`En retard: ${late}`, pad+14, y+64); doc.text(`‚â§ 7 jours: ${week}`, pad+128, y+64);
      doc.setDrawColor(210,210,215); doc.rect(pad+14,y+74,500,12); doc.setFillColor(0,113,227); doc.rect(pad+14,y+74,5*pct,12,'F');
      y += 120;

      const st = { 'En contact': State.data.contacts.filter(c=>c.status==='En contact').length, '√Ä contacter': State.data.contacts.filter(c=>c.status==='√Ä contacter').length, 'Termin√©': State.data.contacts.filter(c=>c.status==='Termin√©').length, 'En attente': State.data.contacts.filter(c=>c.status==='En attente').length };
      doc.setDrawColor(210,210,215); doc.roundedRect(pad,y,523,100,12,12); doc.setFontSize(12); doc.text('Contacts ‚Äî R√©partition', pad+14, y+22);
      let by=y+36; let i=0; const colors=[[0,113,227],[29,29,31],[110,110,115],[211,211,215]];
      Object.entries(st).forEach(([label,val])=>{ const totalC=Math.max(1, State.data.contacts.length); const w=Math.min(500,(val/totalC)*500); const c=colors[i%colors.length]; i++; doc.setFillColor(c[0],c[1],c[2]); doc.rect(pad+14,by,w,12,'F'); doc.setTextColor(0); doc.text(`${label}: ${val}`, pad+520, by+9, {align:'right'}); by+=20; });
      y += 120;

      const upcoming = State.data.tasks.filter(x=>x.status!=='Termin√©' && x.due).sort((a,b)=> (a.due||'').localeCompare(b.due||'')).slice(0,6);
      doc.setFontSize(13); doc.text('√Ä venir ‚Äî prochaines √©ch√©ances', pad, y); y+=18; doc.setFontSize(11);
      if(!upcoming.length){ doc.text('Aucune √©ch√©ance planifi√©e.', pad, y); y+=16; }
      else { upcoming.forEach(ti=>{ const who=(ti.assignees||[]).join(', ')||'‚Äî'; doc.text(`‚Ä¢ ${ti.due} ‚Äî ${ti.title} (${who})`, pad, y); y+=16; }); }

      y += 10; const doneTasks = State.data.tasks.filter(t=>t.status==='Termin√©');
      doc.setFontSize(13); doc.text('R√©sum√© des actions r√©alis√©es', pad, y); y+=18; doc.setFontSize(11);
      if(!doneTasks.length){ doc.text('Aucune t√¢che termin√©e pour le moment.', pad, y); y+=18; }
      else { doneTasks.forEach(tk=>{ const who=(tk.assignees||[]).join(', ')||'non assign√©e'; const when=tk.completedAt? new Date(tk.completedAt).toLocaleDateString() : 'date inconnue'; doc.text(`‚Ä¢ ${tk.title} ‚Äî ${who} ‚Äî termin√© le ${when}`, pad, y); y+=16; }); }

      const taskRows = State.data.tasks.map(t=>[t.title,t.status,t.priority,(t.assignees||[]).join(', '), (t.due||'‚Äî'), (t.notes||'').slice(0,72)]);
      doc.autoTable({ startY:y+10, head:[['T√¢che','Statut','Priorit√©','Assign√©e(s)','√âch√©ance','Notes']], body:taskRows, styles:{fontSize:9,cellPadding:5}, headStyles:{fillColor:[0,113,227],textColor:255}, alternateRowStyles:{fillColor:[245,245,245]} });
      const contactRows = State.data.contacts.map(c=>[c.name,c.type,c.status,c.priority,(c.email||''),(c.social||'')]);
      doc.autoTable({ startY:doc.lastAutoTable.finalY+18, head:[['Nom','Type','Statut','Priorit√©','Email','R√©seaux']], body:contactRows, styles:{fontSize:9,cellPadding:5}, headStyles:{fillColor:[29,29,31],textColor:255}, alternateRowStyles:{fillColor:[245,245,245]} });

      const pageCount=doc.internal.getNumberOfPages(); for(let i=1;i<=pageCount;i++){ doc.setPage(i); const w=doc.internal.pageSize.getWidth(); doc.setFontSize(9); doc.setTextColor(110,110,115); doc.text(`¬© Regards Crois√©s ‚Äî Rapport g√©n√©r√© le ${new Date().toLocaleString()} ‚Äî Page ${i}/${pageCount}`, w/2, doc.internal.pageSize.getHeight()-18, {align:'center'}); }
      doc.save(`RC-Rapport-${Date.now()}.pdf`);
    }

    // Init & events
    function renderAll(){ renderArticles(); renderEpisodes(); renderTasks(); renderContacts(); updateThemePreview(); refreshAssigneeOptions(); buildKanban(); renderTeam(); document.querySelector('#year').textContent = new Date().getFullYear(); }

    function renderTeam(){
      const wrap=$('#team-list'); wrap.innerHTML='';
      if(!State.data.team.length){ wrap.innerHTML='<span class="muted">Aucun membre pour le moment.</span>'; }
      State.data.team.forEach(name=>{
        const btn=document.createElement('button'); btn.className='btn'; btn.textContent=name; btn.title='Supprimer';
        btn.onclick=()=>{ if(!confirm('Retirer '+name+' ?')) return;
          State.data.team=State.data.team.filter(n=>n!==name);
          State.data.tasks = State.data.tasks.map(t=>({...t, assignees:(t.assignees||[]).filter(a=>a!==name)}));
          State.save(); renderTeam(); refreshAssigneeOptions(); renderTasks(); buildKanban();
        };
        wrap.appendChild(btn);
      });
    }

    function seedDemo(){
      State.data = {
        theme: { title:'R√©silience ‚Äî Des voix qui s‚Äô√©l√®vent', desc:'Ce mois‚Äëci, r√©silience des civils face aux conflits.' },
        team: ['Jude','Grace','Alex'],
        articles: [ { id: uid(), title:'Pourquoi ¬´ Regards crois√©s ¬ª ?', tags:['√©ditorial','apolitique'], summary:'T√©moignages authentiques, nuance, contre‚Äër√©cit.' } ],
        episodes: [ { id: uid(), title:'√âpisode 1 ‚Äî Vivre sous le conflit', guests:'journaliste local¬∑e', theme:'Goma (RDC)', status:'Publi√©', date:new Date().toISOString().slice(0,10), image:'media/cover.jpg', audio:'media/sample.wav', link:'' } ],
        tasks: [
          { id: uid(), title:'Contacter journaliste local', status:'En cours', priority:'Haute', notes:'Pitch + cr√©neau', assignees:['Grace'], due:new Date(Date.now()+3*86400000).toISOString().slice(0,10) },
          { id: uid(), title:'R√©diger article √©ditorial', status:'√Ä faire', priority:'Moyenne', notes:'', assignees:['Jude'], due:new Date(Date.now()+9*86400000).toISOString().slice(0,10) },
          { id: uid(), title:'Monter √©pisode 1', status:'Termin√©', priority:'Haute', notes:'Valider compression', assignees:['Grace','Alex'], completedAt:new Date().toISOString(), due:new Date().toISOString().slice(0,10) }
        ],
        contacts: [
          { id: uid(), name:'M√©decins du Monde', type:'Organisation', status:'En contact', priority:'Moyenne', email:'contact@medecinsdumonde.org', social:'@MDM' },
          { id: uid(), name:'J. Dupont (Journaliste)', type:'Personnalit√©', status:'√Ä contacter', priority:'Haute', email:'j.dupont@example.com', social:'@jdupont' }
        ]
      };
      State.save(); renderAll();
    }

    function init(){
      applyTheme(localStorage.getItem(THEME_KEY) || 'cupertino');
      document.getElementById('btn-theme').onclick = toggleTheme;

      State.load();
      if(!State.data.team || !State.data.team.length){ State.data.team=['Jude','Grace']; }
      if(!State.data.articles.length && !State.data.episodes.length && !State.data.tasks.length && !State.data.contacts.length){ seedDemo(); } else { renderAll(); }

      // Tabs
      document.querySelectorAll('.seg').forEach(btn=>btn.onclick=()=>selectTab(btn.dataset.tab));

      // Shortcuts
      document.addEventListener('keydown', (e)=>{
        if(e.key==='/'){ e.preventDefault(); const tab=document.querySelector('.seg[aria-selected="true"]').dataset.tab; const field = document.querySelector(`#tab-${tab} input[placeholder^="Recherche"]`); if(field) field.focus(); }
        if(e.key.toLowerCase()==='t'){ selectTab('tasks'); document.getElementById('task-title').focus(); }
        if(e.key.toLowerCase()==='n'){ const tab=document.querySelector('.seg[aria-selected="true"]').dataset.tab; if(tab==='tasks'){ document.getElementById('task-title').focus(); } else if(tab==='articles'){ document.getElementById('article-title').focus(); } else if(tab==='episodes'){ document.getElementById('ep-title').focus(); } }
      });

      // Team
      const addTeam = (sel)=>{ const name=document.querySelector(sel).value.trim(); if(!name) return; if(State.data.team.includes(name)){ toast('Existe d√©j√†'); return; } State.data.team.push(name); State.save(); document.querySelector(sel).value=''; renderTeam(); refreshAssigneeOptions(); toast('Ajout√©'); };
      document.getElementById('team-add-main').onclick=()=>addTeam('#team-input');
      document.getElementById('team-add').onclick=()=>addTeam('#team-new');

      // Articles
      document.getElementById('article-form')?.addEventListener('submit', e=>{ e.preventDefault(); const id=document.getElementById('article-id').value || uid(); const entry={ id, title:document.getElementById('article-title').value.trim(), tags:stringifyTags(document.getElementById('article-tags').value), summary:document.getElementById('article-summary').value.trim() }; if(!entry.title){ alert('Titre requis'); return; } const ix=State.data.articles.findIndex(a=>a.id===id); if(ix>-1) State.data.articles[ix]=entry; else State.data.articles.unshift(entry); State.save(); e.target.reset(); document.getElementById('article-id').value=''; renderArticles(); toast('Article enregistr√©'); });
      document.getElementById('article-reset').onclick=()=>{ document.getElementById('article-form').reset(); document.getElementById('article-id').value=''; };
      document.getElementById('article-search').oninput=()=>renderArticles();
      document.getElementById('article-clear').onclick=()=>{ if(confirm('Supprimer tous les articles ?')){ State.data.articles=[]; State.save(); renderArticles(); }};

      // Episodes
      document.getElementById('ep-form')?.addEventListener('submit', e=>{ e.preventDefault(); const id=document.getElementById('ep-id').value || uid(); const entry={ id, title:document.getElementById('ep-title').value.trim(), guests:document.getElementById('ep-guests').value.trim(), theme:document.getElementById('ep-theme').value.trim(), image:document.getElementById('ep-image').value.trim(), audio:document.getElementById('ep-audio').value.trim(), link:document.getElementById('ep-link').value.trim(), status:document.getElementById('ep-status').value, date:document.getElementById('ep-date').value }; if(!entry.title){ alert('Titre requis'); return; } const ix=State.data.episodes.findIndex(a=>a.id===id); if(ix>-1) State.data.episodes[ix]=entry; else State.data.episodes.unshift(entry); State.save(); e.target.reset(); document.getElementById('ep-id').value=''; renderEpisodes(); toast('√âpisode enregistr√©'); });
      document.getElementById('ep-reset').onclick=()=>{ document.getElementById('ep-form').reset(); document.getElementById('ep-id').value=''; };
      document.getElementById('ep-search').oninput=()=>renderEpisodes();
      document.getElementById('ep-clear').onclick=()=>{ if(confirm('Supprimer tous les √©pisodes ?')){ State.data.episodes=[]; State.save(); renderEpisodes(); }};

      // Tasks
      document.getElementById('task-form')?.addEventListener('submit', e=>{
        e.preventDefault(); const id=document.getElementById('task-id').value || uid();
        const assignees = Array.from(document.getElementById('task-assignees').selectedOptions).map(o=>o.value);
        const entry={ id, title:document.getElementById('task-title').value.trim(), status:document.getElementById('task-status').value, priority:document.getElementById('task-priority').value, notes:document.getElementById('task-notes').value.trim(), assignees, due:document.getElementById('task-due').value };
        if(!entry.title){ alert('Titre requis'); return; }
        const ix=State.data.tasks.findIndex(a=>a.id===id);
        if(ix>-1){
          const prev=State.data.tasks[ix];
          if(entry.status==='Termin√©' && prev.status!=='Termin√©' && !prev.completedAt){ entry.completedAt = new Date().toISOString(); }
          if(prev.completedAt && entry.status==='Termin√©') entry.completedAt = prev.completedAt;
          State.data.tasks[ix]=entry;
        }else{
          if(entry.status==='Termin√©') entry.completedAt=new Date().toISOString();
          State.data.tasks.unshift(entry);
        }
        State.save(); e.target.reset(); document.getElementById('task-id').value=''; renderTasks(); buildKanban(); toast('T√¢che enregistr√©e');
      });
      document.getElementById('task-reset').onclick=()=>{ document.getElementById('task-form').reset(); document.getElementById('task-id').value=''; };
      document.getElementById('task-search').oninput=()=>renderTasks();
      document.getElementById('task-clear').onclick=()=>{ if(confirm('Supprimer toutes les t√¢ches ?')){ State.data.tasks=[]; State.save(); renderTasks(); buildKanban(); }};
      document.getElementById('view-list').onclick=()=>{ document.getElementById('task-list').classList.remove('hidden'); document.getElementById('task-kanban').classList.add('hidden'); };
      document.getElementById('view-kanban').onclick=()=>{ document.getElementById('task-kanban').classList.remove('hidden'); document.getElementById('task-list').classList.add('hidden'); buildKanban(); };

      // Contacts
      document.getElementById('contact-form')?.addEventListener('submit', e=>{ e.preventDefault(); const id=document.getElementById('contact-id').value || uid(); const entry={ id, name:document.getElementById('contact-name').value.trim(), type:document.getElementById('contact-type').value, status:document.getElementById('contact-status').value, priority:document.getElementById('contact-priority').value, email:document.getElementById('contact-email').value.trim(), social:document.getElementById('contact-social').value.trim() }; if(!entry.name){ alert('Nom requis'); return; } const ix=State.data.contacts.findIndex(a=>a.id===id); if(ix>-1) State.data.contacts[ix]=entry; else State.data.contacts.unshift(entry); State.save(); e.target.reset(); document.getElementById('contact-id').value=''; renderContacts(); toast('Contact enregistr√©'); });
      document.getElementById('contact-reset').onclick=()=>{ document.getElementById('contact-form').reset(); document.getElementById('contact-id').value=''; };
      document.getElementById('contact-search').oninput=()=>renderContacts();
      document.getElementById('contact-clear').onclick=()=>{ if(confirm('Supprimer tous les contacts ?')){ State.data.contacts=[]; State.save(); renderContacts(); }};

      // Theme form
      document.getElementById('theme-form').addEventListener('submit', e=>{ e.preventDefault(); State.data.theme={ title:document.getElementById('theme-title').value.trim(), desc:document.getElementById('theme-desc').value.trim() }; State.save(); updateThemePreview(); toast('Th√®me mis √† jour'); });

      // PDF
      document.getElementById('btn-pdf').onclick=exportPDF;

      // Reset + Demo
      document.getElementById('btn-reset').onclick=()=>{ if(confirm('Tout r√©initialiser ?')){ localStorage.removeItem(KEY); State.load(); renderAll(); toast('R√©initialis√©'); } };
      document.getElementById('btn-demo').onclick=()=>{ if(confirm('√âcraser les donn√©es actuelles par une d√©mo ?')) seedDemo(); };
    }

    // PWA
    let deferredPrompt; const installBtn=document.getElementById('btn-install');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt=e; installBtn.style.display='block'; });
    installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; });
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
