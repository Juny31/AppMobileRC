<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Regards CroisÃ©s â€” Media Manager (PWA)</title>
<meta name="theme-color" content="#0a1e3a" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
/* (styles condensed for brevity but equivalent look) */
:root{--bg:#071427;--card:#0d1e3a;--muted:#b7c6dc;--text:#f5f9ff;--brand:#2f7fef;--brand-2:#7ac3ff;--line:#18406e;--danger:#ef4444;--warn:#f59e0b;--ok:#10b981;--radius:18px;--shadow:0 14px 30px rgba(4,12,24,.28);--accent-articles:#69b7ff;--accent-episodes:#06b6d4;--accent-tasks:#f59e0b;--accent-contacts:#10b981}
[data-theme="light"]{--bg:#f6fbff;--card:#fff;--muted:#5a708c;--text:#0a1e3a;--brand:#0b4abf;--brand-2:#69b7ff;--line:#e6edf6;--shadow:0 10px 24px rgba(8,18,36,.12)}
body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:radial-gradient(1200px 600px at -10% -10%, #0a2d62 0, transparent 60%), linear-gradient(180deg,var(--bg),#0b1830)}
.container{max-width:1100px;margin:auto;padding:16px}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(10,29,58,.9), rgba(10,29,58,.7));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.brand{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
.logo{height:42px;width:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;font-weight:800;color:#001228;box-shadow:inset 0 0 0 3px rgba(255,255,255,.35)}
h1{font-size:18px;margin:0}.sub{font-size:12px;color:var(--muted)}
.bar{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:8px 16px}
.tab{appearance:none;border:0;border-radius:14px;padding:10px 12px;color:var(--text);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));box-shadow:inset 0 0 0 1px var(--line);font-weight:800}
.tab[aria-selected="true"]{background:linear-gradient(135deg,rgba(42,124,255,.2),rgba(122,195,255,.18));box-shadow:inset 0 0 0 2px rgba(42,124,255,.6)}
.card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px;border:1px solid var(--line)}.muted{color:var(--muted)}.grid{display:grid;gap:14px}
@media(min-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(122,195,255,.12);border:1px solid rgba(122,195,255,.35);color:var(--text)}
input,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text)}textarea{min-height:100px}
.actions{display:flex;gap:8px;flex-wrap:wrap}button{cursor:pointer;border:0;padding:12px 14px;border-radius:12px;font-weight:800;letter-spacing:.2px}
.btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#001228}.btn-outline{background:transparent;box-shadow:inset 0 0 0 2px var(--line);color:var(--text)}.btn-danger{background:#ef4444;color:#fff}
.btn-warn{background:#f59e0b;color:#000}.btn-ok{background:#10b981;color:#001228}.hidden{display:none}.pill{padding:6px 10px;border-radius:999px;background:rgba(122,195,255,.16);border:1px solid rgba(122,195,255,.35)}
.progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);overflow:hidden}.progress>div{height:100%;background:linear-gradient(90deg,#f59e0b,#ffd479)}
.status{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand container"><div class="row"><div class="logo">RC</div><div><h1>Regards CroisÃ©s â€” Media Manager</h1><div class="sub">Mobileâ€‘first â€¢ PWA â€¢ Inter</div></div></div><button id="btn-theme" class="tab">Sombre</button></div>
  <nav class="bar container" role="tablist">
    <button class="tab" aria-selected="true" data-tab="home">Accueil</button>
    <button class="tab" data-tab="articles">ğŸ“° Articles</button>
    <button class="tab" data-tab="episodes">ğŸ™ Podcasts</button>
    <button class="tab" data-tab="tasks">ğŸ“‹ TÃ¢ches</button>
    <button class="tab" data-tab="contacts">ğŸ“‡ Contacts</button>
    <button class="tab" data-tab="settings">Sauvegarde</button>
  </nav>
</header>

<main class="container">
  <section id="tab-home">
    <div class="card"><img src="media/cover.jpg" alt="cover" style="width:100%;border-radius:14px;border:1px solid var(--line)"><p class="muted">Regards croisÃ©s â€” Les conflits vus par les opprimÃ©s</p></div>
    <div class="grid" style="margin-top:8px">
      <div class="card">
        <h3>ğŸ¯ ThÃ¨me du mois</h3>
        <form id="theme-form">
          <label>Titre<input id="theme-title" placeholder="ex: RÃ©silienceâ€¦"></label>
          <label>Description<textarea id="theme-desc" placeholder="Angle Ã©ditorial du moisâ€¦"></textarea></label>
          <div class="actions"><button class="btn-primary" type="submit">Enregistrer</button></div>
        </form>
        <p class="muted" id="theme-preview"></p>
      </div>
      <div class="card"><h3>Intention Ã©ditoriale</h3><p class="muted">TÃ©moignages authentiques â€¢ Nuance â€¢ Empathie â€¢ Apolitique</p></div>
    </div>
  </section>

  <section id="tab-articles" class="hidden">
    <div class="card">
      <h3>ğŸ“° Ajouter / Ã©diter un article</h3>
      <form id="article-form">
        <input type="hidden" id="article-id" />
        <label>Titre<input id="article-title" required></label>
        <label>Tags<input id="article-tags" placeholder="sociÃ©tÃ©, conflitâ€¦"></label>
        <label>RÃ©sumÃ©<textarea id="article-summary"></textarea></label>
        <div class="actions"><button type="submit" class="btn-primary">Enregistrer</button><button type="button" id="article-reset" class="btn-outline">Annuler</button></div>
      </form>
    </div>
    <div class="actions" style="margin:10px 0"><input id="article-search" placeholder="Rechercheâ€¦"><button id="article-clear" class="btn-outline">Vider la liste</button></div>
    <div id="article-list" class="grid"></div>
  </section>

  <section id="tab-episodes" class="hidden">
    <div class="card">
      <h3>ğŸ™ Ajouter / Ã©diter un Ã©pisode</h3>
      <form id="ep-form">
        <input type="hidden" id="ep-id" />
        <label>Titre<input id="ep-title" required></label>
        <label>InvitÃ©(s)<input id="ep-guests"></label>
        <label>ThÃ¨me<input id="ep-theme"></label>
        <label>URL image<input id="ep-image" type="url"></label>
        <label>URL audio<input id="ep-audio" type="url"></label>
        <label>Lien mÃ©dia<input id="ep-link" type="url"></label>
        <div class="actions"><button type="submit" class="btn-primary">Enregistrer</button><button type="button" id="ep-reset" class="btn-outline">Annuler</button></div>
      </form>
    </div>
    <div class="actions" style="margin:10px 0"><input id="ep-search" placeholder="Rechercheâ€¦"><button id="ep-clear" class="btn-outline">Vider la liste</button></div>
    <div id="ep-list" class="grid"></div>
  </section>

  <section id="tab-tasks" class="hidden">
    <div class="card">
      <h3>ğŸ“‹ Gestion des tÃ¢ches</h3>
      <form id="task-form">
        <input type="hidden" id="task-id" />
        <label>Titre<input id="task-title" required></label>
        <label>Statut<select id="task-status"><option>Ã€ faire</option><option>En cours</option><option>TerminÃ©</option></select></label>
        <label>PrioritÃ©<select id="task-priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></label>
        <label>Notes<textarea id="task-notes"></textarea></label>
        <div class="actions"><button type="submit" class="btn-primary">Enregistrer</button><button type="button" id="task-reset" class="btn-outline">Annuler</button></div>
      </form>
    </div>
    <div class="card"><h3>Statistiques</h3><div class="row"><span>Total <b id="stat-task-total">0</b></span><span>TerminÃ©es <b id="stat-task-done">0</b></span><span>Haute prioritÃ© <b id="stat-task-high">0</b></span></div><div class="progress"><div id="task-progress" style="width:0%"></div></div></div>
    <div class="actions" style="margin:10px 0"><input id="task-search" placeholder="Rechercheâ€¦"><button id="task-clear" class="btn-outline">Vider la liste</button></div>
    <div id="task-list" class="grid"></div>
  </section>

  <section id="tab-contacts" class="hidden">
    <div class="card">
      <h3>ğŸ“‡ Gestion des contacts</h3>
      <form id="contact-form">
        <input type="hidden" id="contact-id" />
        <label>Nom<input id="contact-name" required></label>
        <label>Type<select id="contact-type"><option>Organisation</option><option>PersonnalitÃ©</option></select></label>
        <label>Statut<select id="contact-status"><option>En contact</option><option>Ã€ contacter</option><option>TerminÃ©</option><option>En attente</option></select></label>
        <label>PrioritÃ©<select id="contact-priority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select></label>
        <label>Email<input id="contact-email" type="email"></label>
        <label>RÃ©seaux<input id="contact-social"></label>
        <div class="actions"><button type="submit" class="btn-primary">Enregistrer</button><button type="button" id="contact-reset" class="btn-outline">Annuler</button></div>
      </form>
    </div>
    <div class="card"><h3>Statistiques par statut</h3><div class="row"><span>En contact <b id="st-contacted">0</b></span><span>Ã€ contacter <b id="st-tocontact">0</b></span><span>TerminÃ© <b id="st-done">0</b></span><span>En attente <b id="st-pending">0</b></span></div><div id="contact-bars" class="grid"></div></div>
    <div class="actions" style="margin:10px 0"><input id="contact-search" placeholder="Rechercheâ€¦"><button id="contact-clear" class="btn-outline">Vider la liste</button></div>
    <div id="contact-list" class="grid"></div>
  </section>

  <section id="tab-settings" class="hidden">
    <div class="card">
      <h3>Export / Import</h3>
      <div class="row"><button id="btn-export" class="btn-primary">Exporter donnÃ©es (JSON)</button><label class="btn-outline">Importer JSON<input id="file-import" type="file" accept="application/json" style="display:none"></label><button id="btn-demo" class="btn-warn">RecrÃ©er donnÃ©es dÃ©mo</button><button id="btn-reset" class="btn-danger">RÃ©initialiser tout</button></div>
    </div>
    <div class="card">
      <h3>ğŸ“„ Export PDF avancÃ©</h3>
      <p class="muted">Rapport avec enâ€‘tÃªte, stats, tableaux colorÃ©s.</p>
      <button id="btn-pdf" class="btn-ok">Exporter le rapport PDF</button>
    </div>
  </section>
</main>

<button id="btn-install" class="btn-primary" style="position:fixed;bottom:16px;right:16px;display:none">Installer lâ€™app</button>
<footer class="container"><small>Â© <span id="year"></span> Regards CroisÃ©s Â· PWA GitHub Pages</small></footer>

<script>
const KEY='rc-data-pro-v1', THEME_KEY='rc-theme', $=s=>document.querySelector(s);
const State={data:{articles:[],episodes:[],tasks:[],contacts:[],theme:{title:'',desc:''}},save(){localStorage.setItem(KEY,JSON.stringify(this.data))},load(){const r=localStorage.getItem(KEY);this.data=r?JSON.parse(r):{articles:[],episodes:[],tasks:[],contacts:[],theme:{title:'',desc:''}}}};
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);$('#btn-theme').textContent=(t==='light'?'Clair':'Sombre');localStorage.setItem(THEME_KEY,t)}
function toggleTheme(){const cur=document.documentElement.getAttribute('data-theme')||'dark';applyTheme(cur==='dark'?'light':'dark')}
function uid(){return Math.random().toString(36).slice(2,9)};function stringifyTags(v){return (v||'').split(',').map(t=>t.trim()).filter(Boolean)};function matches(q,...f){q=q.toLowerCase();return f.some(x=>(x||'').toLowerCase().includes(q))}
function selectTab(name){document.querySelectorAll('.tab').forEach(b=>b.setAttribute('aria-selected',String(b.dataset.tab===name)));document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));document.querySelector('#tab-'+name).classList.remove('hidden')}
function download(filename,text){const blob=new Blob([text],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url)}

// Articles
function renderArticles(list=State.data.articles){const q=$('#article-search')?.value?.trim().toLowerCase()||'';const filtered=q?list.filter(a=>matches(q,a.title,a.summary,(a.tags||[]).join(','))):list;const wrap=$('#article-list');if(!wrap)return;wrap.innerHTML='';if(!filtered.length){wrap.innerHTML='<div class="card muted">Aucun article.</div>';return;}for(const a of filtered){const el=document.createElement('div');el.className='card';el.innerHTML=`<h3>${a.title}</h3><p class="muted">${a.summary||''}</p><div class="row" style="margin:6px 0">${(a.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('')}</div><div class="actions"><button class="btn-outline" data-edit="${a.id}">Ã‰diter</button><button class="btn-danger" data-del="${a.id}">Supprimer</button></div>`;wrap.appendChild(el)}wrap.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>editArticle(b.dataset.edit));wrap.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delArticle(b.dataset.del))}
function editArticle(id){const a=State.data.articles.find(x=>x.id===id);if(!a)return;$('#article-id').value=a.id;$('#article-title').value=a.title;$('#article-tags').value=(a.tags||[]).join(', ');$('#article-summary').value=a.summary||'';window.scrollTo({top:0,behavior:'smooth'});selectTab('articles')}
function delArticle(id){if(!confirm('Supprimer cet article ?'))return;State.data.articles=State.data.articles.filter(x=>x.id!==id);State.save();renderArticles()}

// Episodes
function renderEpisodes(list=State.data.episodes){const q=$('#ep-search')?.value?.trim().toLowerCase()||'';const filtered=q?list.filter(e=>matches(q,e.title,e.guests,e.theme)):list;const wrap=$('#ep-list');if(!wrap)return;wrap.innerHTML='';if(!filtered.length){wrap.innerHTML='<div class="card muted">Aucun Ã©pisode.</div>';return;}for(const e of filtered){const el=document.createElement('div');el.className='card';const img=e.image?`<img src="${e.image}" alt="visuel" style="width:100%;border-radius:12px;border:1px solid var(--line);margin-bottom:8px"/>`:'';const audio=e.audio?`<audio controls style="width:100%;margin-top:8px"><source src="${e.audio}"></audio>`:'';el.innerHTML=`${img}<h3>${e.title}</h3><p class="muted">InvitÃ©(s): ${e.guests||'â€”'} â€¢ ThÃ¨me: ${e.theme||'â€”'}</p>${e.link?`<a class="btn-outline" href="${e.link}" target="_blank" rel="noopener">Ã‰couter</a>`:''}${audio}<div class="actions" style="margin-top:8px"><button class="btn-outline" data-ep-edit="${e.id}">Ã‰diter</button><button class="btn-danger" data-ep-del="${e.id}">Supprimer</button></div>`;wrap.appendChild(el)}wrap.querySelectorAll('[data-ep-edit]').forEach(b=>b.onclick=()=>editEpisode(b.dataset.epEdit));wrap.querySelectorAll('[data-ep-del]').forEach(b=>b.onclick=()=>delEpisode(b.dataset.epDel))}
function editEpisode(id){const e=State.data.episodes.find(x=>x.id===id);if(!e)return;$('#ep-id').value=e.id;$('#ep-title').value=e.title;$('#ep-guests').value=e.guests||'';$('#ep-theme').value=e.theme||'';$('#ep-link').value=e.link||'';$('#ep-image').value=e.image||'';$('#ep-audio').value=e.audio||'';window.scrollTo({top:0,behavior:'smooth'});selectTab('episodes')}
function delEpisode(id){if(!confirm('Supprimer cet Ã©pisode ?'))return;State.data.episodes=State.data.episodes.filter(x=>x.id!==id);State.save();renderEpisodes()}

// Tasks
function computeTaskStats(){const t=State.data.tasks;const total=t.length;const done=t.filter(x=>x.status==='TerminÃ©').length;const high=t.filter(x=>x.priority==='Haute').length;$('#stat-task-total').textContent=total;$('#stat-task-done').textContent=done;$('#stat-task-high').textContent=high;const pct=total?Math.round((done/total)*100):0;$('#task-progress').style.width=pct+'%';$('#task-progress').title=pct+'%'}
function renderTasks(list=State.data.tasks){computeTaskStats();const q=$('#task-search')?.value?.trim().toLowerCase()||'';const filtered=q?list.filter(t=>matches(q,t.title,t.notes)):list;const wrap=$('#task-list');if(!wrap)return;wrap.innerHTML='';if(!filtered.length){wrap.innerHTML='<div class="card muted">Aucune tÃ¢che.</div>';return;}for(const t of filtered){const el=document.createElement('div');el.className='card';const st=t.status, pr=t.priority;el.innerHTML=`<h3>${t.title}</h3><div class="row" style="margin:6px 0"><span class="status">${st}</span><span class="status" style="border-color:var(--accent-tasks);color:var(--accent-tasks)">${pr}</span></div>${t.notes?`<p class="muted">${t.notes}</p>`:''}<div class="actions"><button class="btn-outline" data-task-edit="${t.id}">Ã‰diter</button><button class="btn-danger" data-task-del="${t.id}">Supprimer</button></div>`;wrap.appendChild(el)}wrap.querySelectorAll('[data-task-edit]').forEach(b=>b.onclick=()=>editTask(b.dataset.taskEdit));wrap.querySelectorAll('[data-task-del]').forEach(b=>b.onclick=()=>delTask(b.dataset.taskDel))}
function editTask(id){const t=State.data.tasks.find(x=>x.id===id);if(!t)return;$('#task-id').value=t.id;$('#task-title').value=t.title;$('#task-status').value=t.status;$('#task-priority').value=t.priority;$('#task-notes').value=t.notes||'';window.scrollTo({top:0,behavior:'smooth'});selectTab('tasks')}
function delTask(id){if(!confirm('Supprimer cette tÃ¢che ?'))return;State.data.tasks=State.data.tasks.filter(x=>x.id!==id);State.save();renderTasks()}

// Contacts
function computeContactStats(){const c=State.data.contacts;const by=s=>c.filter(x=>x.status===s).length;$('#st-contacted').textContent=by('En contact');$('#st-tocontact').textContent=by('Ã€ contacter');$('#st-done').textContent=by('TerminÃ©');$('#st-pending').textContent=by('En attente');const total=c.length||1;const bars=[['En contact',by('En contact')],['Ã€ contacter',by('Ã€ contacter')],['TerminÃ©',by('TerminÃ©')],['En attente',by('En attente')]];const wrap=document.getElementById('contact-bars');if(!wrap)return;wrap.innerHTML='';bars.forEach(([label,val])=>{const pct=Math.round((val/total)*100);const card=document.createElement('div');card.className='card';card.innerHTML=`<div class="row" style="justify-content:space-between"><span>${label}</span><b>${val}</b></div><div class="progress" style="margin-top:8px"><div style="width:${pct}%"></div></div>`;wrap.appendChild(card)})}
function renderContacts(list=State.data.contacts){computeContactStats();const q=$('#contact-search')?.value?.trim().toLowerCase()||'';const filtered=q?list.filter(c=>matches(q,c.name,c.email,c.social)):list;const wrap=$('#contact-list');if(!wrap)return;wrap.innerHTML='';if(!filtered.length){wrap.innerHTML='<div class="card muted">Aucun contact.</div>';return;}for(const c of filtered){const el=document.createElement('div');el.className='card';el.innerHTML=`<h3>${c.name}</h3><div class="row" style="margin:6px 0"><span class="status">${c.status}</span><span class="status" style="border-color:var(--accent-contacts);color:var(--accent-contacts)">${c.type}</span><span class="status" style="border-color:var(--accent-tasks);color:var(--accent-tasks)">${c.priority}</span></div><p class="muted">${c.email||''} ${c.social?('â€¢ '+c.social):''}</p><div class="actions"><button class="btn-outline" data-contact-edit="${c.id}">Ã‰diter</button><button class="btn-danger" data-contact-del="${c.id}">Supprimer</button></div>`;wrap.appendChild(el)}wrap.querySelectorAll('[data-contact-edit]').forEach(b=>b.onclick=()=>editContact(b.dataset.contactEdit));wrap.querySelectorAll('[data-contact-del]').forEach(b=>b.onclick=()=>delContact(b.dataset.contactDel))}
function editContact(id){const c=State.data.contacts.find(x=>x.id===id);if(!c)return;$('#contact-id').value=c.id;$('#contact-name').value=c.name;$('#contact-type').value=c.type;$('#contact-status').value=c.status;$('#contact-priority').value=c.priority;$('#contact-email').value=c.email||'';$('#contact-social').value=c.social||'';window.scrollTo({top:0,behavior:'smooth'});selectTab('contacts')}
function delContact(id){if(!confirm('Supprimer ce contact ?'))return;State.data.contacts=State.data.contacts.filter(x=>x.id!==id);State.save();renderContacts()}

// Export / Import / Demo
function exportData(){download('regards-croises-backup.json',JSON.stringify(State.data,null,2))}
async function importData(file){const text=await file.text();try{const data=JSON.parse(text);if(!data||!data.articles||!data.episodes||!data.tasks||!data.contacts)throw new Error('format');State.data=data;State.save();renderArticles();renderEpisodes();renderTasks();renderContacts();updateThemePreview();alert('Import rÃ©ussi !')}catch(e){alert('Fichier invalide.')}}
function seedDemo(){State.data={theme:{title:'RÃ©silience â€” Des voix qui sâ€™Ã©lÃ¨vent',desc:'Ce moisâ€‘ci, rÃ©silience des civils face aux conflits.'},articles:[{id:uid(),title:'Pourquoi Â« Regards croisÃ©s Â» ?',tags:['Ã©ditorial','apolitique'],summary:'TÃ©moignages authentiques, nuance, contreâ€‘rÃ©cit.'}],episodes:[{id:uid(),title:'Ã‰pisode 1 â€” Vivre sous le conflit',guests:'journaliste localÂ·e',theme:'Goma (RDC)',image:'media/cover.jpg',audio:'media/sample.wav'}],tasks:[{id:uid(),title:'Contacter journaliste local',status:'En cours',priority:'Haute',notes:'RepÃ©rage sur Instagram'},{id:uid(),title:'Monter Ã©pisode 1',status:'TerminÃ©',priority:'Haute',notes:''}],contacts:[{id:uid(),name:'MÃ©decins du Monde',type:'Organisation',status:'En contact',priority:'Moyenne',email:'contact@medecinsdumonde.org',social:'@MDM'}]};State.save();renderArticles();renderEpisodes();renderTasks();renderContacts();updateThemePreview()}

// Theme of the month
function updateThemePreview(){const t=State.data.theme||{title:'',desc:''};$('#theme-title').value=t.title||'';$('#theme-desc').value=t.desc||'';$('#theme-preview').textContent=t.title?(t.title+' â€” '+(t.desc||'')):'Aucun thÃ¨me dÃ©fini.'}

// PDF
async function ensureJsPdf(){if(!window.jspdf){await new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';s.onload=res;s.onerror=rej;document.head.appendChild(s);});}if(!window.jspdf||!window.jspdf.jsPDF)throw new Error('jsPDF indisponible');if(!window.jspdfAutoTable){await new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js';s.onload=res;s.onerror=rej;document.head.appendChild(s);});}}
async function exportPDF(){try{await ensureJsPdf()}catch(e){alert('Impossible de charger jsPDF.');return}const {jsPDF}=window.jspdf;const doc=new jsPDF({unit:'pt',format:'a4'});const pad=36;let y=pad;doc.setFillColor(10,30,58);doc.rect(0,0,doc.internal.pageSize.getWidth(),70,'F');doc.setTextColor(255,255,255);doc.setFontSize(16);doc.text('Regards CroisÃ©s â€” Rapport',pad,28);doc.setFontSize(10);doc.text(new Date().toLocaleString(),pad,44);doc.setTextColor(0);y=86;const theme=State.data.theme||{title:'',desc:''};doc.setDrawColor(105,183,255);doc.roundedRect(pad,y,523,70,8,8);doc.setFontSize(12);doc.text('ThÃ¨me du mois',pad+10,y+18);doc.setFontSize(14);doc.text(theme.title||'â€”',pad+10,y+38);doc.setFontSize(11);doc.text((theme.desc||'â€”').substring(0,120),pad+10,y+56);y+=86;const t=State.data.tasks;const total=t.length,done=t.filter(x=>x.status==='TerminÃ©').length,high=t.filter(x=>x.priority==='Haute').length,pct=total?Math.round((done/total)*100):0;doc.setDrawColor(245,158,11);doc.roundedRect(pad,y,523,70,8,8);doc.setFontSize(12);doc.text('TÃ¢ches â€” Statistiques',pad+10,y+18);doc.setFontSize(11);doc.text(`Total: ${total}`,pad+10,y+38);doc.text(`TerminÃ©es: ${done}`,pad+120,y+38);doc.text(`Haute prioritÃ©: ${high}`,pad+260,y+38);doc.setDrawColor(200);doc.rect(pad+10,y+48,500,10);doc.setFillColor(245,158,11);doc.rect(pad+10,y+48,5*pct,10,'F');y+=86;const st={'En contact':State.data.contacts.filter(c=>c.status==='En contact').length,'Ã€ contacter':State.data.contacts.filter(c=>c.status==='Ã€ contacter').length,'TerminÃ©':State.data.contacts.filter(c=>c.status==='TerminÃ©').length,'En attente':State.data.contacts.filter(c=>c.status==='En attente').length};doc.setDrawColor(16,185,129);doc.roundedRect(pad,y,523,90,8,8);doc.setFontSize(12);doc.text('Contacts â€” RÃ©partition',pad+10,y+18);let by=y+30,i=0;const colors=[[16,185,129],[105,183,255],[34,197,94],[245,158,11]];Object.entries(st).forEach(([label,val])=>{const w=Math.min(500,(val/Math.max(1,State.data.contacts.length))*500);const c=colors[i%colors.length];i++;doc.setFillColor(c[0],c[1],c[2]);doc.rect(pad+10,by,w,10,'F');doc.setTextColor(0);doc.text(`${label}: ${val}`,pad+10+510,by+8,{align:'right'});by+=18});y+=106;const taskRows=State.data.tasks.map(t=>[t.title,t.status,t.priority,(t.notes||'').slice(0,60)]);doc.autoTable({startY:y,head:[['TÃ¢che','Statut','PrioritÃ©','Notes']],body:taskRows,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:[245,158,11],textColor:0},alternateRowStyles:{fillColor:[245,245,245]}});y=doc.lastAutoTable.finalY+14;const contactRows=State.data.contacts.map(c=>[c.name,c.type,c.status,c.priority,(c.email||''),(c.social||'')]);doc.autoTable({startY:y,head:[['Nom','Type','Statut','PrioritÃ©','Email','RÃ©seaux']],body:contactRows,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:[16,185,129],textColor:0},alternateRowStyles:{fillColor:[245,245,245]}});const pageCount=doc.internal.getNumberOfPages();for(let i=1;i<=pageCount;i++){doc.setPage(i);const w=doc.internal.pageSize.getWidth();doc.setFontSize(9);doc.text(`Â© Regards CroisÃ©s â€” Rapport gÃ©nÃ©rÃ© le ${new Date().toLocaleString()} â€” Page ${i}/${pageCount}`,w/2,doc.internal.pageSize.getHeight()-14,{align:'center'})}doc.save(`RC-Rapport-${Date.now()}.pdf`)}

// Init
function init(){const t=localStorage.getItem(THEME_KEY)||'dark';applyTheme(t);$('#btn-theme').onclick=toggleTheme;State.load();if(!State.data.articles.length&&!State.data.episodes.length&&!State.data.tasks.length&&!State.data.contacts.length)seedDemo();renderArticles();renderEpisodes();renderTasks();renderContacts();updateThemePreview();document.querySelector('#year').textContent=new Date().getFullYear();document.querySelectorAll('.tab').forEach(btn=>btn.onclick=()=>selectTab(btn.dataset.tab));$('#article-form')?.addEventListener('submit',e=>{e.preventDefault();const id=$('#article-id').value||uid();const entry={id,title:$('#article-title').value.trim(),tags:stringifyTags($('#article-tags').value),summary:$('#article-summary').value.trim()};if(!entry.title){alert('Titre requis');return}const ix=State.data.articles.findIndex(a=>a.id===id);if(ix>-1)State.data.articles[ix]=entry;else State.data.articles.unshift(entry);State.save();e.target.reset();$('#article-id').value='';renderArticles()});$('#article-reset')?.addEventListener('click',()=>{$('#article-form').reset();$('#article-id').value=''});$('#article-search')?.addEventListener('input',()=>renderArticles());$('#article-clear')?.addEventListener('click',()=>{if(confirm('Supprimer tous les articles ?')){State.data.articles=[];State.save();renderArticles()}});$('#ep-form')?.addEventListener('submit',e=>{e.preventDefault();const id=$('#ep-id').value||uid();const entry={id,title:$('#ep-title').value.trim(),guests:$('#ep-guests').value.trim(),theme:$('#ep-theme').value.trim(),image:$('#ep-image').value.trim(),audio:$('#ep-audio').value.trim(),link:$('#ep-link').value.trim()};if(!entry.title){alert('Titre requis');return}const ix=State.data.episodes.findIndex(a=>a.id===id);if(ix>-1)State.data.episodes[ix]=entry;else State.data.episodes.unshift(entry);State.save();e.target.reset();$('#ep-id').value='';renderEpisodes()});$('#ep-reset')?.addEventListener('click',()=>{$('#ep-form').reset();$('#ep-id').value=''});$('#ep-search')?.addEventListener('input',()=>renderEpisodes());$('#ep-clear')?.addEventListener('click',()=>{if(confirm('Supprimer tous les Ã©pisodes ?')){State.data.episodes=[];State.save();renderEpisodes()}});$('#task-form')?.addEventListener('submit',e=>{e.preventDefault();const id=$('#task-id').value||uid();const entry={id,title:$('#task-title').value.trim(),status:$('#task-status').value,priority:$('#task-priority').value,notes:$('#task-notes').value.trim()};if(!entry.title){alert('Titre requis');return}const ix=State.data.tasks.findIndex(a=>a.id===id);if(ix>-1)State.data.tasks[ix]=entry;else State.data.tasks.unshift(entry);State.save();e.target.reset();$('#task-id').value='';renderTasks()});$('#task-reset')?.addEventListener('click',()=>{$('#task-form').reset();$('#task-id').value=''});$('#task-search')?.addEventListener('input',()=>renderTasks());$('#task-clear')?.addEventListener('click',()=>{if(confirm('Supprimer toutes les tÃ¢ches ?')){State.data.tasks=[];State.save();renderTasks()}});$('#contact-form')?.addEventListener('submit',e=>{e.preventDefault();const id=$('#contact-id').value||uid();const entry={id,name:$('#contact-name').value.trim(),type:$('#contact-type').value,status:$('#contact-status').value,priority:$('#contact-priority').value,email:$('#contact-email').value.trim(),social:$('#contact-social').value.trim()};if(!entry.name){alert('Nom requis');return}const ix=State.data.contacts.findIndex(a=>a.id===id);if(ix>-1)State.data.contacts[ix]=entry;else State.data.contacts.unshift(entry);State.save();e.target.reset();$('#contact-id').value='';renderContacts()});$('#contact-reset')?.addEventListener('click',()=>{$('#contact-form').reset();$('#contact-id').value=''});$('#contact-search')?.addEventListener('input',()=>renderContacts());$('#contact-clear')?.addEventListener('click',()=>{if(confirm('Supprimer tous les contacts ?')){State.data.contacts=[];State.save();renderContacts()}});$('#theme-form')?.addEventListener('submit',e=>{e.preventDefault();State.data.theme={title:$('#theme-title').value.trim(),desc:$('#theme-desc').value.trim()};State.save();updateThemePreview();alert('ThÃ¨me mis Ã  jour.')});$('#btn-export')?.addEventListener('click',exportData);$('#file-import')?.addEventListener('change',e=>{const f=e.target.files[0];if(f)importData(f);e.target.value=''});$('#btn-reset')?.addEventListener('click',()=>{if(confirm('Tout rÃ©initialiser ?')){localStorage.removeItem(KEY);State.load();renderArticles();renderEpisodes();renderTasks();renderContacts();updateThemePreview()}});$('#btn-demo')?.addEventListener('click',()=>{if(confirm('Ã‰craser les donnÃ©es actuelles ?'))seedDemo()});$('#btn-pdf')?.addEventListener('click',exportPDF)}
document.addEventListener('DOMContentLoaded',init);

// PWA install + SW
let deferredPrompt;const installBtn=document.getElementById('btn-install');window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='block'});installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.style.display='none'});if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'))}
</script>
</body>
</html>
