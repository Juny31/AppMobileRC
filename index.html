<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Regards Crois√©s ‚Äî App</title>
  <meta name="theme-color" content="#1d1d1f"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root {
      --bg: #000000;
      --bg-secondary: #1d1d1f;
      --bg-tertiary: #2d2d30;
      --card: #161618;
      --card-hover: #1f1f23;
      --text: #f5f5f7;
      --text-secondary: #a1a1a6;
      --text-muted: #6e6e73;
      --border: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(255, 255, 255, 0.2);
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --success: #28cd41;
      --warning: #ff9f0a;
      --danger: #ff3b30;
      --shadow: rgba(0, 0, 0, 0.3);
      --shadow-lg: rgba(0, 0, 0, 0.5);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --space-xs: 8px;
      --space-sm: 12px;
      --space-md: 20px;
      --space-lg: 32px;
      --space-xl: 48px;
      --space-2xl: 72px;
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    [data-theme="light"] {
      --bg: #ffffff;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #f2f2f7;
      --card: #ffffff;
      --card-hover: #f5f5f7;
      --text: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-muted: #8e8e93;
      --border: rgba(0, 0, 0, 0.1);
      --border-hover: rgba(0, 0, 0, 0.2);
      --shadow: rgba(0, 0, 0, 0.1);
      --shadow-lg: rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Inter, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
      transition: all 0.3s ease;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: saturate(180%) blur(20px);
      background: rgba(0, 0, 0, 0.8);
      border-bottom: 1px solid var(--border);
    }

    [data-theme="light"] header {
      background: rgba(255, 255, 255, 0.8);
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 0 var(--space-lg);
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md) 0;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .title h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .bar {
      display: flex;
      gap: var(--space-xs);
      padding: var(--space-sm) 0 var(--space-md);
      border-top: 1px solid var(--border);
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .bar::-webkit-scrollbar {
      display: none;
    }

    .seg {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding: var(--space-sm) var(--space-md);
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-size: 14px;
    }

    .seg:hover {
      background: var(--card-hover);
      border-color: var(--border-hover);
    }

    .seg[aria-selected="true"] {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    /* Main Content */
    main {
      padding: var(--space-xl) 0;
      min-height: calc(100vh - 200px);
    }

    .grid {
      display: grid;
      gap: var(--space-lg);
    }

    @media(min-width: 980px) {
      .grid {
        grid-template-columns: 1.2fr 0.8fr;
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      box-shadow: 0 4px 20px var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
    }

    .card:hover {
      background: var(--card-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--shadow-lg);
    }

    .card h3 {
      margin: 0 0 var(--space-md);
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    /* Form Elements */
    input, textarea, select {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
      background: var(--card);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    label {
      display: block;
      margin-bottom: var(--space-md);
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Buttons */
    .btn {
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card);
      padding: var(--space-sm) var(--space-md);
      border-radius: 50px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-size: 14px;
      color: var(--text);
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: var(--card-hover);
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 15px rgba(0, 113, 227, 0.3);
    }

    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #d70015;
      box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
    }

    .actions {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      align-items: center;
      margin-top: var(--space-md);
    }

    /* Status Elements */
    .pill {
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 6px var(--space-sm);
      font-size: 12px;
      font-weight: 500;
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }

    .status {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .progress {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 50px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress > div {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    /* Kanban */
    .kanban {
      display: grid;
      gap: var(--space-md);
    }

    @media(min-width: 980px) {
      .kanban {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .col {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      min-height: 200px;
      background: var(--bg-secondary);
      transition: all 0.2s ease;
    }

    .col:hover {
      border-color: var(--border-hover);
      background: var(--card);
    }

    .col h4 {
      margin: 0 0 var(--space-md);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kan-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--space-sm);
      background: var(--card);
      margin-bottom: var(--space-sm);
      cursor: grab;
      transition: all 0.2s ease;
    }

    .kan-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .kan-card:active {
      cursor: grabbing;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .muted {
      color: var(--text-muted);
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: var(--space-lg);
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      padding: var(--space-sm) var(--space-md);
      border-radius: 50px;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 30px var(--shadow-lg);
      font-weight: 500;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Footer */
    footer {
      padding: var(--space-xl) 0;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      margin-top: var(--space-2xl);
      background: var(--bg-secondary);
      text-align: center;
    }

    /* Install Button */
    #btn-install {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: 1000;
      box-shadow: 0 8px 30px var(--shadow-lg);
      display: none;
    }

    /* Theme Toggle */
    #btn-theme {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    #btn-theme:hover {
      background: var(--card);
      color: var(--text);
    }

    /* Search and Filters */
    .search-container {
      display: flex;
      gap: var(--space-sm);
      margin: var(--space-md) 0;
      flex-wrap: wrap;
    }

    .search-container input {
      flex: 1;
      min-width: 200px;
    }

    .search-container select {
      min-width: 180px;
    }

    /* Statistics Cards */
    .stats-grid {
      display: grid;
      gap: var(--space-sm);
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      margin: var(--space-md) 0;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--space-sm);
      text-align: center;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      background: var(--card);
      transform: translateY(-1px);
    }

    .stat-card .number {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-card .label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 var(--space-md);
      }
      
      .brand {
        flex-direction: column;
        gap: var(--space-sm);
        align-items: stretch;
      }
      
      .brand-left {
        justify-content: center;
      }
      
      .actions {
        justify-content: center;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: var(--space-md);
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .search-container input,
      .search-container select {
        min-width: auto;
      }
    }

    /* Form Groups */
    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-row {
      display: grid;
      gap: var(--space-md);
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    /* Enhanced Visual Elements */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border);
    }

    .badge {
      background: var(--accent);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.success {
      background: var(--success);
    }

    .badge.warning {
      background: var(--warning);
    }

    .badge.danger {
      background: var(--danger);
    }
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="brand-left">
        <div class="logo">RC</div>
        <div class="title"><h1>Regards Crois√©s ‚Äî App</h1></div>
      </div>
      <div class="actions">
        <a class="btn" href="index.html">Accueil</a>
        <button id="btn-theme" class="btn">üåô Sombre</button>
      </div>
    </div>
    <div class="container bar" role="tablist">
      <button class="seg" aria-selected="true" data-tab="home">Accueil</button>
      <button class="seg" data-tab="articles">Articles</button>
      <button class="seg" data-tab="episodes">Podcasts</button>
      <button class="seg" data-tab="tasks">T√¢ches</button>
      <button class="seg" data-tab="contacts">Contacts</button>
      <button class="seg" data-tab="settings">R√©glages</button>
    </div>
  </header>

  <main class="container">
    <section id="tab-home">
      <div class="grid">
        <div class="card slide-in">
          <div class="card-header">
            <h3>Th√®me du mois</h3>
            <span class="badge">√âditorial</span>
          </div>
          <form id="theme-form">
            <div class="form-group">
              <label>Titre</label>
              <input id="theme-title" placeholder="ex: R√©silience ‚Äî Des voix qui s'√©l√®vent">
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="theme-desc" placeholder="Angle √©ditorial du mois‚Ä¶"></textarea>
            </div>
            <div class="actions">
              <button class="btn btn-primary" type="submit">Enregistrer</button>
            </div>
          </form>
          <p class="muted" id="theme-preview"></p>
        </div>
        <div class="card slide-in">
          <div class="card-header">
            <h3>Guidelines visuelles</h3>
            <span class="badge success">Design</span>
          </div>
          <p class="muted">Interface sombre √©l√©gante, espaces g√©n√©reux, cartes a√©r√©es, accent bleu #0071e3, typographie Apple SF Pro, animations fluides.</p>
          <div class="stats-grid" style="margin-top: var(--space-md);">
            <div class="stat-card">
              <div class="number">12px</div>
              <div class="label">Radius</div>
            </div>
            <div class="stat-card">
              <div class="number">32px</div>
              <div class="label">Spacing</div>
            </div>
            <div class="stat-card">
              <div class="number">600</div>
              <div class="label">Font Weight</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-articles" class="hidden">
      <div class="card slide-in">
        <div class="card-header">
          <h3>Articles</h3>
          <span class="badge" id="article-count">0</span>
        </div>
        <form id="article-form">
          <input type="hidden" id="article-id">
          <div class="form-row">
            <div class="form-group">
              <label>Titre</label>
              <input id="article-title" required>
            </div>
            <div class="form-group">
              <label>Tags</label>
              <input id="article-tags" placeholder="soci√©t√©, conflit‚Ä¶">
            </div>
          </div>
          <div class="form-group">
            <label>R√©sum√©</label>
            <textarea id="article-summary"></textarea>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <button type="button" id="article-reset" class="btn">Annuler</button>
          </div>
        </form>
      </div>
      <div class="search-container">
        <input id="article-search" placeholder="üîç Recherche‚Ä¶">
        <button id="article-clear" class="btn btn-danger">Vider la liste</button>
      </div>
      <div id="article-list" class="grid"></div>
    </section>

    <section id="tab-episodes" class="hidden">
      <div class="card slide-in">
        <div class="card-header">
          <h3>Podcasts</h3>
          <span class="badge warning" id="episode-count">0</span>
        </div>
        <form id="ep-form">
          <input type="hidden" id="ep-id">
          <div class="form-row">
            <div class="form-group">
              <label>Titre</label>
              <input id="ep-title" required>
            </div>
            <div class="form-group">
              <label>Invit√©(s)</label>
              <input id="ep-guests">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Th√®me</label>
              <input id="ep-theme">
            </div>
            <div class="form-group">
              <label>Statut</label>
              <select id="ep-status">
                <option>Brouillon</option>
                <option>Publi√©</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date</label>
              <input id="ep-date" type="date">
            </div>
            <div class="form-group">
              <label>Image (URL)</label>
              <input id="ep-image" type="url">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Audio (URL)</label>
              <input id="ep-audio" type="url">
            </div>
            <div class="form-group">
              <label>Lien m√©dia</label>
              <input id="ep-link" type="url">
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <button type="button" id="ep-reset" class="btn">Annuler</button>
          </div>
        </form>
      </div>
      <div class="search-container">
        <input id="ep-search" placeholder="üîç Recherche‚Ä¶">
        <button id="ep-clear" class="btn btn-danger">Vider la liste</button>
      </div>
      <div id="ep-list" class="grid"></div>
    </section>

    <section id="tab-tasks" class="hidden">
      <div class="card slide-in">
        <div class="card-header">
          <h3>T√¢ches</h3>
          <span class="badge" id="task-count">0</span>
        </div>
        <form id="task-form">
          <input type="hidden" id="task-id">
          <div class="form-row">
            <div class="form-group">
              <label>Titre</label>
              <input id="task-title" required placeholder="ex: Contacter journaliste‚Ä¶">
            </div>
            <div class="form-group">
              <label>Statut</label>
              <select id="task-status">
                <option>√Ä faire</option>
                <option>En cours</option>
                <option>Termin√©</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Priorit√©</label>
              <select id="task-priority">
                <option>Haute</option>
                <option>Moyenne</option>
                <option>Basse</option>
              </select>
            </div>
            <div class="form-group">
              <label>√âch√©ance</label>
              <input id="task-due" type="date">
            </div>
          </div>
          <div class="form-group">
            <label>Assign√©e(s) üë•</label>
            <select id="task-assignees" multiple size="4" title="Ctrl/Cmd + clic pour multi-s√©lection"></select>
          </div>
          <div class="actions">
            <input id="team-new" placeholder="Ajouter un pr√©nom (ex: Alex)" style="max-width:280px; margin-right: auto;">
            <button id="team-add" type="button" class="btn">Ajouter au groupe</button>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="task-notes"></textarea>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <button type="button" id="task-reset" class="btn">Annuler</button>
          </div>
        </form>
      </div>

      <div class="card slide-in">
        <div class="card-header">
          <h3>Statistiques</h3>
          <div class="actions">
            <button id="view-list" class="btn">üìã Liste</button>
            <button id="view-kanban" class="btn">üìä Kanban</button>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="stat-task-total">0</div>
            <div class="label">Total</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-task-done">0</div>
            <div class="label">Termin√©es</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-task-high">0</div>
            <div class="label">Haute priorit√©</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-task-late">0</div>
            <div class="label">En retard</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-task-week">0</div>
            <div class="label">‚â§ 7 jours</div>
          </div>
        </div>
        <div class="progress" style="margin-top: var(--space-md);">
          <div id="task-progress" style="width:0%"></div>
        </div>
      </div>

      <div class="search-container">
        <input id="task-search" placeholder="üîç Recherche titre / notes‚Ä¶">
        <select id="task-sort">
          <option value="updated">Tri : modifi√© r√©cemment</option>
          <option value="due">Tri : par √©ch√©ance</option>
          <option value="priority">Tri : par priorit√©</option>
        </select>
        <button id="task-clear" class="btn btn-danger">Vider la liste</button>
      </div>

      <div id="task-list" class="grid"></div>
      <div id="task-kanban" class="kanban hidden">
        <div class="col" data-col="√Ä faire">
          <h4>√Ä faire</h4>
          <div class="drop" data-status="√Ä faire"></div>
        </div>
        <div class="col" data-col="En cours">
          <h4>En cours</h4>
          <div class="drop" data-status="En cours"></div>
        </div>
        <div class="col" data-col="Termin√©">
          <h4>Termin√©</h4>
          <div class="drop" data-status="Termin√©"></div>
        </div>
      </div>
    </section>

    <section id="tab-contacts" class="hidden">
      <div class="card slide-in">
        <div class="card-header">
          <h3>Contacts</h3>
          <span class="badge" id="contact-count">0</span>
        </div>
        <form id="contact-form">
          <input type="hidden" id="contact-id">
          <div class="form-row">
            <div class="form-group">
              <label>Nom</label>
              <input id="contact-name" required>
            </div>
            <div class="form-group">
              <label>Type</label>
              <select id="contact-type">
                <option>Organisation</option>
                <option>Personnalit√©</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Statut</label>
              <select id="contact-status">
                <option>En contact</option>
                <option>√Ä contacter</option>
                <option>Termin√©</option>
                <option>En attente</option>
              </select>
            </div>
            <div class="form-group">
              <label>Priorit√©</label>
              <select id="contact-priority">
                <option>Haute</option>
                <option>Moyenne</option>
                <option>Basse</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input id="contact-email" type="email">
            </div>
            <div class="form-group">
              <label>R√©seaux</label>
              <input id="contact-social">
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <button type="button" id="contact-reset" class="btn">Annuler</button>
          </div>
        </form>
      </div>
      
      <div class="card slide-in">
        <div class="card-header">
          <h3>R√©partition</h3>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="st-contacted">0</div>
            <div class="label">En contact</div>
          </div>
          <div class="stat-card">
            <div class="number" id="st-tocontact">0</div>
            <div class="label">√Ä contacter</div>
          </div>
          <div class="stat-card">
            <div class="number" id="st-done">0</div>
            <div class="label">Termin√©</div>
          </div>
          <div class="stat-card">
            <div class="number" id="st-pending">0</div>
            <div class="label">En attente</div>
          </div>
        </div>
        <div id="contact-bars" class="grid" style="margin-top: var(--space-md);"></div>
      </div>
      
      <div class="search-container">
        <input id="contact-search" placeholder="üîç Recherche‚Ä¶">
        <button id="contact-clear" class="btn btn-danger">Vider la liste</button>
      </div>
      <div id="contact-list" class="grid"></div>
    </section>

    <section id="tab-settings" class="hidden">
      <div class="card slide-in">
        <div class="card-header">
          <h3>√âquipe (assignation par pr√©noms)</h3>
          <span class="badge" id="team-count">0</span>
        </div>
        <div class="actions" style="margin-bottom: var(--space-md);">
          <input id="team-input" placeholder="Ajouter un pr√©nom (ex: Alex)" style="max-width:300px; margin-right: auto;">
          <button id="team-add-main" class="btn btn-primary" type="button">Ajouter</button>
        </div>
        <div id="team-list" class="actions"></div>
      </div>
      
      <div class="card slide-in">
        <div class="card-header">
          <h3>Export PDF</h3>
          <span class="badge success">Rapport</span>
        </div>
        <p class="muted">Logo, stats, √©ch√©ances, r√©capitulatif des t√¢ches termin√©es avec design professionnel.</p>
        <button id="btn-pdf" class="btn btn-primary">üìÑ Exporter le rapport PDF</button>
      </div>
      
      <div class="card slide-in">
        <div class="card-header">
          <h3>Maintenance</h3>
          <span class="badge warning">Admin</span>
        </div>
        <div class="actions">
          <button id="btn-demo" class="btn">üé¨ Recr√©er donn√©es d√©mo</button>
          <button id="btn-reset" class="btn btn-danger">üóëÔ∏è R√©initialiser tout</button>
        </div>
      </div>
    </section>
  </main>

  <button id="btn-install" class="btn btn-primary">üì± Installer l'app</button>
  <div id="toast" role="status" aria-live="polite"></div>
  
  <footer class="container">
    <small>¬© <span id="year"></span> Regards Crois√©s ‚Äî Application de gestion</small>
  </footer>

  <script>
    const KEY = 'rc-data-modern-v1';
    const THEME_KEY = 'rc-theme';
    const $ = s => document.querySelector(s);
    
    const State = {
      data: {
        articles: [],
        episodes: [],
        tasks: [],
        contacts: [],
        theme: { title: '', desc: '' },
        team: []
      },
      save() {
        localStorage.setItem(KEY, JSON.stringify(this.data));
      },
      load() {
        const saved = localStorage.getItem(KEY);
        this.data = saved ? JSON.parse(saved) : {
          articles: [],
          episodes: [],
          tasks: [],
          contacts: [],
          theme: { title: '', desc: '' },
          team: ['Jude', 'Grace']
        };
      }
    };

    // Theme management
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const btn = $('#btn-theme');
      btn.textContent = theme === 'dark' ? '‚òÄÔ∏è Clair' : 'üåô Sombre';
      localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }

    // Utility functions
    function toast(msg) {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function uid() {
      return Math.random().toString(36).slice(2, 9);
    }

    function stringifyTags(v) {
      return (v || '').split(',').map(t => t.trim()).filter(Boolean);
    }

    function matches(q, ...fields) {
      q = q.toLowerCase();
      return fields.some(x => (x || '').toLowerCase().includes(q));
    }

    function selectTab(name) {
      try {
        console.log('selectTab called with:', name);
        
        // Update tab buttons
        document.querySelectorAll('.seg').forEach(b => {
          const isSelected = b.dataset.tab === name;
          b.setAttribute('aria-selected', String(isSelected));
          console.log(`Tab ${b.dataset.tab} selected: ${isSelected}`);
        });
        
        // Hide all sections
        document.querySelectorAll('main section').forEach(s => {
          s.classList.add('hidden');
        });
        
        // Show target section
        const target = document.querySelector('#tab-' + name);
        if (target) {
          target.classList.remove('hidden');
          console.log(`Showing section: #tab-${name}`);
          
          // Add slide-in animation to cards
          target.querySelectorAll('.card').forEach((card, i) => {
            card.style.animationDelay = `${i * 0.1}s`;
            card.classList.add('slide-in');
          });
        } else {
          console.error(`Section #tab-${name} not found`);
        }
      } catch (error) {
        console.error('Error in selectTab:', error);
      }
    }

    function updateCounts() {
      $('#article-count').textContent = State.data.articles.length;
      $('#episode-count').textContent = State.data.episodes.length;
      $('#task-count').textContent = State.data.tasks.length;
      $('#contact-count').textContent = State.data.contacts.length;
      $('#team-count').textContent = State.data.team.length;
    }

    function refreshAssigneeOptions() {
      const sel = $('#task-assignees');
      if (!sel) return;
      const selected = Array.from(sel.selectedOptions).map(o => o.value);
      sel.innerHTML = (State.data.team || []).map(n => 
        `<option value="${n}">${n}</option>`
      ).join('');
      selected.forEach(v => {
        const option = [...sel.options].find(x => x.value === v);
        if (option) option.selected = true;
      });
    }

    // Articles functions
    function renderArticles(list = State.data.articles) {
      const q = $('#article-search')?.value?.trim().toLowerCase() || '';
      const filtered = q ? list.filter(a => 
        matches(q, a.title, a.summary, (a.tags || []).join(','))
      ) : list;
      
      const wrap = $('#article-list');
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (!filtered.length) {
        wrap.innerHTML = '<div class="card muted">Aucun article trouv√©.</div>';
        return;
      }
      
      filtered.forEach(a => {
        const el = document.createElement('div');
        el.className = 'card slide-in';
        el.innerHTML = `
          <h3>${a.title}</h3>
          <p class="muted">${a.summary || 'Aucun r√©sum√©'}</p>
          <div class="actions" style="margin: var(--space-sm) 0;">
            ${(a.tags || []).map(t => `<span class="pill">#${t}</span>`).join('')}
          </div>
          <div class="actions">
            <button class="btn" data-edit="${a.id}">‚úèÔ∏è √âditer</button>
            <button class="btn btn-danger" data-del="${a.id}">üóëÔ∏è Supprimer</button>
          </div>
        `;
        wrap.appendChild(el);
      });
      
      wrap.querySelectorAll('[data-edit]').forEach(b => 
        b.onclick = () => editArticle(b.dataset.edit)
      );
      wrap.querySelectorAll('[data-del]').forEach(b => 
        b.onclick = () => delArticle(b.dataset.del)
      );
    }

    function editArticle(id) {
      const a = State.data.articles.find(x => x.id === id);
      if (!a) return;
      $('#article-id').value = a.id;
      $('#article-title').value = a.title;
      $('#article-tags').value = (a.tags || []).join(', ');
      $('#article-summary').value = a.summary || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      selectTab('articles');
    }

    function delArticle(id) {
      if (!confirm('Supprimer cet article ?')) return;
      State.data.articles = State.data.articles.filter(x => x.id !== id);
      State.save();
      renderArticles();
      updateCounts();
      toast('Article supprim√©');
    }

    // Episodes functions
    function renderEpisodes(list = State.data.episodes) {
      const q = $('#ep-search')?.value?.trim().toLowerCase() || '';
      const filtered = q ? list.filter(e => 
        matches(q, e.title, e.guests, e.theme, e.status, e.date)
      ) : list;
      
      const wrap = $('#ep-list');
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (!filtered.length) {
        wrap.innerHTML = '<div class="card muted">Aucun √©pisode trouv√©.</div>';
        return;
      }
      
      filtered.forEach(e => {
        const el = document.createElement('div');
        el.className = 'card slide-in';
        const img = e.image ? 
          `<img src="${e.image}" alt="visuel" style="width:100%;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:var(--space-md)">` : '';
        const audio = e.audio ? 
          `<audio controls style="width:100%;margin-top:var(--space-sm)"><source src="${e.audio}"></audio>` : '';
        
        el.innerHTML = `
          ${img}
          <h3>${e.title}</h3>
          <div class="actions" style="margin: var(--space-sm) 0;">
            <span class="status ${e.status === 'Publi√©' ? 'success' : ''}">${e.status || 'Brouillon'}</span>
            ${e.date ? `<span class="pill">üìÖ ${e.date}</span>` : ''}
          </div>
          <p class="muted">
            <strong>Invit√©(s):</strong> ${e.guests || '‚Äî'}<br>
            <strong>Th√®me:</strong> ${e.theme || '‚Äî'}
          </p>
          ${audio}
          <div class="actions" style="margin-top: var(--space-md);">
            ${e.link ? `<a class="btn" href="${e.link}" target="_blank" rel="noopener">üéß √âcouter</a>` : ''}
            <button class="btn" data-ep-edit="${e.id}">‚úèÔ∏è √âditer</button>
            <button class="btn btn-danger" data-ep-del="${e.id}">üóëÔ∏è Supprimer</button>
          </div>
        `;
        wrap.appendChild(el);
      });
      
      wrap.querySelectorAll('[data-ep-edit]').forEach(b => 
        b.onclick = () => editEpisode(b.dataset.epEdit)
      );
      wrap.querySelectorAll('[data-ep-del]').forEach(b => 
        b.onclick = () => delEpisode(b.dataset.epDel)
      );
    }

    function editEpisode(id) {
      const e = State.data.episodes.find(x => x.id === id);
      if (!e) return;
      $('#ep-id').value = e.id;
      $('#ep-title').value = e.title;
      $('#ep-guests').value = e.guests || '';
      $('#ep-theme').value = e.theme || '';
      $('#ep-link').value = e.link || '';
      $('#ep-image').value = e.image || '';
      $('#ep-audio').value = e.audio || '';
      $('#ep-status').value = e.status || 'Brouillon';
      $('#ep-date').value = e.date || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      selectTab('episodes');
    }

    function delEpisode(id) {
      if (!confirm('Supprimer cet √©pisode ?')) return;
      State.data.episodes = State.data.episodes.filter(x => x.id !== id);
      State.save();
      renderEpisodes();
      updateCounts();
      toast('√âpisode supprim√©');
    }

    // Tasks functions
    function computeTaskStats() {
      const t = State.data.tasks;
      const total = t.length;
      const done = t.filter(x => x.status === 'Termin√©').length;
      const high = t.filter(x => x.priority === 'Haute').length;
      const now = new Date();
      const weekAhead = new Date();
      weekAhead.setDate(now.getDate() + 7);
      const late = t.filter(x => x.status !== 'Termin√©' && x.due && new Date(x.due) < now).length;
      const week = t.filter(x => x.status !== 'Termin√©' && x.due && 
        new Date(x.due) <= weekAhead && new Date(x.due) >= now).length;
      
      $('#stat-task-total').textContent = total;
      $('#stat-task-done').textContent = done;
      $('#stat-task-high').textContent = high;
      $('#stat-task-late').textContent = late;
      $('#stat-task-week').textContent = week;
      
      const pct = total ? Math.round((done / total) * 100) : 0;
      $('#task-progress').style.width = pct + '%';
      $('#task-progress').title = pct + '%';
    }

    function sortTasks(list) {
      const mode = $('#task-sort').value;
      const priRank = { Haute: 0, Moyenne: 1, Basse: 2 };
      
      if (mode === 'due') {
        return list.slice().sort((a, b) => (a.due || '').localeCompare(b.due || ''));
      }
      if (mode === 'priority') {
        return list.slice().sort((a, b) => 
          (priRank[a.priority] ?? 9) - (priRank[b.priority] ?? 9)
        );
      }
      return list.slice();
    }

    function renderTasks(list = State.data.tasks) {
      computeTaskStats();
      const q = $('#task-search')?.value?.trim().toLowerCase() || '';
      const filtered = q ? list.filter(t => 
        matches(q, t.title, t.notes, (t.assignees || []).join(','))
      ) : list;
      const sorted = sortTasks(filtered);
      
      const wrap = $('#task-list');
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (!sorted.length) {
        wrap.innerHTML = '<div class="card muted">Aucune t√¢che trouv√©e.</div>';
        return;
      }
      
      sorted.forEach(t => {
        const el = document.createElement('div');
        el.className = 'card slide-in';
        el.draggable = true;
        el.dataset.id = t.id;
        
        const who = t.assignees || [];
        const due = t.due ? ` üìÖ ${t.due}` : '';
        const overdue = t.status !== 'Termin√©' && t.due && (new Date(t.due) < new Date());
        
        el.innerHTML = `
          <h3>${t.title}</h3>
          <div class="actions" style="margin: var(--space-sm) 0;">
            <span class="status ${t.status === 'Termin√©' ? 'success' : t.status === 'En cours' ? 'warning' : ''}">${t.status}</span>
            <span class="status ${t.priority === 'Haute' ? 'danger' : t.priority === 'Moyenne' ? 'warning' : ''}">${t.priority}</span>
            ${who.length ? who.map(n => `<span class="pill">üë§ ${n}</span>`).join('') : '<span class="pill">‚Äî</span>'}
          </div>
          <p class="muted">${t.notes || 'Aucune note'}${due}</p>
          <div class="actions">
            <button class="btn" data-task-edit="${t.id}">‚úèÔ∏è √âditer</button>
            <button class="btn btn-danger" data-task-del="${t.id}">üóëÔ∏è Supprimer</button>
          </div>
        `;
        
        if (overdue) {
          el.style.border = '2px solid var(--danger)';
          el.style.background = 'rgba(255, 59, 48, 0.05)';
        }
        
        wrap.appendChild(el);
      });
      
      wrap.querySelectorAll('[data-task-edit]').forEach(b => 
        b.onclick = () => editTask(b.dataset.taskEdit)
      );
      wrap.querySelectorAll('[data-task-del]').forEach(b => 
        b.onclick = () => delTask(b.dataset.taskDel)
      );
      
      // Drag and drop setup
      wrap.querySelectorAll('.card').forEach(c => {
        c.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', c.dataset.id);
        });
      });
    }

    function buildKanban() {
      const areas = document.querySelectorAll('#task-kanban .drop');
      areas.forEach(a => {
        a.innerHTML = '';
        const status = a.dataset.status;
        const items = State.data.tasks.filter(t => t.status === status);
        
        items.forEach(t => {
          const k = document.createElement('div');
          k.className = 'kan-card';
          k.draggable = true;
          k.dataset.id = t.id;
          
          const who = t.assignees || [];
          k.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-xs);">
              <strong>${t.title}</strong>
              <span class="status ${t.priority === 'Haute' ? 'danger' : t.priority === 'Moyenne' ? 'warning' : ''}">${t.priority}</span>
            </div>
            <div class="muted" style="font-size: 12px;">
              üë§ ${who.join(', ') || '‚Äî'} ${t.due ? ('üìÖ ' + t.due) : ''}
            </div>
          `;
          
          k.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', t.id);
          });
          
          a.appendChild(k);
        });
        
        a.addEventListener('dragover', e => e.preventDefault());
        a.addEventListener('drop', e => {
          e.preventDefault();
          const id = e.dataTransfer.getData('text/plain');
          const idx = State.data.tasks.findIndex(x => x.id === id);
          if (idx < 0) return;
          
          const prev = State.data.tasks[idx];
          State.data.tasks[idx] = {
            ...prev,
            status: status,
            completedAt: status === 'Termin√©' ? (prev.completedAt || new Date().toISOString()) : prev.completedAt
          };
          
          State.save();
          renderTasks();
          buildKanban();
          toast('Statut mis √† jour');
        });
      });
    }

    function editTask(id) {
      const t = State.data.tasks.find(x => x.id === id);
      if (!t) return;
      $('#task-id').value = t.id;
      $('#task-title').value = t.title;
      $('#task-status').value = t.status;
      $('#task-priority').value = t.priority;
      $('#task-notes').value = t.notes || '';
      $('#task-due').value = t.due || '';
      
      refreshAssigneeOptions();
      const sel = $('#task-assignees');
      [...sel.options].forEach(o => 
        o.selected = (t.assignees || []).includes(o.value)
      );
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      selectTab('tasks');
    }

    function delTask(id) {
      if (!confirm('Supprimer cette t√¢che ?')) return;
      State.data.tasks = State.data.tasks.filter(x => x.id !== id);
      State.save();
      renderTasks();
      buildKanban();
      updateCounts();
      toast('T√¢che supprim√©e');
    }

    // Contacts functions
    function computeContactStats() {
      const c = State.data.contacts;
      const by = s => c.filter(x => x.status === s).length;
      
      $('#st-contacted').textContent = by('En contact');
      $('#st-tocontact').textContent = by('√Ä contacter');
      $('#st-done').textContent = by('Termin√©');
      $('#st-pending').textContent = by('En attente');
    }

    function renderContacts(list = State.data.contacts) {
      computeContactStats();
      const q = $('#contact-search')?.value?.trim().toLowerCase() || '';
      const filtered = q ? list.filter(c => 
        matches(q, c.name, c.email, c.social)
      ) : list;
      
      const wrap = $('#contact-list');
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (!filtered.length) {
        wrap.innerHTML = '<div class="card muted">Aucun contact trouv√©.</div>';
        return;
      }
      
      filtered.forEach(c => {
        const el = document.createElement('div');
        el.className = 'card slide-in';
        
        el.innerHTML = `
          <h3>${c.name}</h3>
          <div class="actions" style="margin: var(--space-sm) 0;">
            <span class="status ${c.status === 'En contact' ? 'success' : c.status === '√Ä contacter' ? 'warning' : ''}">${c.status}</span>
            <span class="status">${c.type}</span>
            <span class="status ${c.priority === 'Haute' ? 'danger' : c.priority === 'Moyenne' ? 'warning' : ''}">${c.priority}</span>
          </div>
          <p class="muted">
            ${c.email ? 'üìß ' + c.email : ''}
            ${c.social ? ' üåê ' + c.social : ''}
          </p>
          <div class="actions">
            <button class="btn" data-contact-edit="${c.id}">‚úèÔ∏è √âditer</button>
            <button class="btn btn-danger" data-contact-del="${c.id}">üóëÔ∏è Supprimer</button>
          </div>
        `;
        wrap.appendChild(el);
      });
      
      wrap.querySelectorAll('[data-contact-edit]').forEach(b => 
        b.onclick = () => editContact(b.dataset.contactEdit)
      );
      wrap.querySelectorAll('[data-contact-del]').forEach(b => 
        b.onclick = () => delContact(b.dataset.contactDel)
      );
    }

    function editContact(id) {
      const c = State.data.contacts.find(x => x.id === id);
      if (!c) return;
      $('#contact-id').value = c.id;
      $('#contact-name').value = c.name;
      $('#contact-type').value = c.type;
      $('#contact-status').value = c.status;
      $('#contact-priority').value = c.priority;
      $('#contact-email').value = c.email || '';
      $('#contact-social').value = c.social || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      selectTab('contacts');
    }

    function delContact(id) {
      if (!confirm('Supprimer ce contact ?')) return;
      State.data.contacts = State.data.contacts.filter(x => x.id !== id);
      State.save();
      renderContacts();
      updateCounts();
      toast('Contact supprim√©');
    }

    // Theme functions
    function updateThemePreview() {
      const t = State.data.theme || { title: '', desc: '' };
      $('#theme-title').value = t.title || '';
      $('#theme-desc').value = t.desc || '';
      $('#theme-preview').textContent = t.title ? 
        (t.title + ' ‚Äî ' + (t.desc || '')) : 'Aucun th√®me d√©fini.';
    }

    // Team functions
    function renderTeam() {
      const wrap = $('#team-list');
      wrap.innerHTML = '';
      
      if (!State.data.team.length) {
        wrap.innerHTML = '<span class="muted">Aucun membre pour le moment.</span>';
        return;
      }
      
      State.data.team.forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = `üë§ ${name}`;
        btn.title = 'Supprimer';
        btn.onclick = () => {
          if (!confirm('Retirer ' + name + ' ?')) return;
          State.data.team = State.data.team.filter(n => n !== name);
          State.data.tasks = State.data.tasks.map(t => ({
            ...t,
            assignees: (t.assignees || []).filter(a => a !== name)
          }));
          State.save();
          renderTeam();
          refreshAssigneeOptions();
          renderTasks();
          buildKanban();
          updateCounts();
          toast(`${name} retir√© de l'√©quipe`);
        };
        wrap.appendChild(btn);
      });
    }

    // Enhanced PDF Export with better error handling and fallback
    async function exportPDF() {
      try {
        toast('üîÑ Pr√©paration du rapport PDF...');
        
        // Load jsPDF from CDN with better error handling
        if (!window.jspdf) {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        }
        
        // Load AutoTable plugin
        if (!window.jspdfAutoTable) {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/dist/jspdf.plugin.autotable.min.js');
        }

        if (!window.jspdf || !window.jspdf.jsPDF) {
          throw new Error('jsPDF non disponible');
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        
        // Color palette
        const colors = {
          primary: [0, 113, 227],
          secondary: [29, 29, 31],
          muted: [110, 110, 115],
          success: [40, 205, 65],
          warning: [255, 159, 10],
          danger: [255, 59, 48],
          background: [245, 245, 247],
          white: [255, 255, 255]
        };

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 48;
        let yPos = margin;

        // Header with background
        doc.setFillColor(...colors.background);
        doc.rect(0, 0, pageWidth, 80, 'F');
        
        // Logo
        doc.setFillColor(...colors.primary);
        doc.roundedRect(margin, 20, 32, 32, 8, 8, 'F');
        doc.setFillColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('RC', margin + 8, 42);

        // Title
        doc.setTextColor(...colors.secondary);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('Regards Crois√©s', margin + 48, 36);
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...colors.muted);
        doc.text('Rapport de gestion', margin + 48, 54);

        // Date
        const now = new Date();
        const dateStr = now.toLocaleDateString('fr-FR', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        doc.setFontSize(11);
        doc.text(`G√©n√©r√© le ${dateStr}`, pageWidth - margin, 42, { align: 'right' });

        yPos = 100;

        // Theme section
        const theme = State.data.theme || { title: '', desc: '' };
        doc.setFillColor(...colors.white);
        doc.setDrawColor(...colors.background);
        doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 90, 12, 12, 'FD');
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.primary);
        doc.text('TH√àME DU MOIS', margin + 20, yPos + 25);
        
        doc.setFontSize(16);
        doc.setTextColor(...colors.secondary);
        doc.text(theme.title || 'Non d√©fini', margin + 20, yPos + 50);
        
        if (theme.desc) {
          doc.setFontSize(11);
          doc.setTextColor(...colors.muted);
          const lines = doc.splitTextToSize(theme.desc, pageWidth - 2 * margin - 40);
          doc.text(lines.slice(0, 2), margin + 20, yPos + 70);
        }
        
        yPos += 110;

        // Statistics Overview
        doc.setFillColor(...colors.white);
        doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 120, 12, 12, 'FD');
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.primary);
        doc.text('VUE D\'ENSEMBLE', margin + 20, yPos + 25);

        // Stats grid
        const stats = [
          { label: 'Articles', value: State.data.articles.length, color: colors.primary },
          { label: '√âpisodes', value: State.data.episodes.length, color: colors.warning },
          { label: 'T√¢ches', value: State.data.tasks.length, color: colors.secondary },
          { label: 'Contacts', value: State.data.contacts.length, color: colors.success }
        ];

        const statWidth = (pageWidth - 2 * margin - 80) / 4;
        stats.forEach((stat, i) => {
          const x = margin + 20 + i * (statWidth + 10);
          const y = yPos + 45;
          
          doc.setFillColor(250, 250, 252);
          doc.roundedRect(x, y, statWidth, 50, 6, 6, 'F');
          
          doc.setFontSize(24);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...stat.color);
          doc.text(stat.value.toString(), x + statWidth/2, y + 25, { align: 'center' });
          
          doc.setFontSize(10);
          doc.setTextColor(...colors.muted);
          doc.text(stat.label.toUpperCase(), x + statWidth/2, y + 40, { align: 'center' });
        });

        yPos += 140;

        // Task Statistics
        const tasks = State.data.tasks;
        const taskStats = {
          total: tasks.length,
          done: tasks.filter(t => t.status === 'Termin√©').length,
          inProgress: tasks.filter(t => t.status === 'En cours').length,
          todo: tasks.filter(t => t.status === '√Ä faire').length,
          high: tasks.filter(t => t.priority === 'Haute').length,
          overdue: tasks.filter(t => t.status !== 'Termin√©' && t.due && new Date(t.due) < new Date()).length
        };

        doc.setFillColor(...colors.white);
        doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 140, 12, 12, 'FD');
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.primary);
        doc.text('ANALYSE DES T√ÇCHES', margin + 20, yPos + 25);

        // Progress bar
        const progressWidth = pageWidth - 2 * margin - 40;
        const completionRate = taskStats.total > 0 ? (taskStats.done / taskStats.total) : 0;
        
        doc.setFillColor(240, 240, 245);
        doc.roundedRect(margin + 20, yPos + 40, progressWidth, 8, 4, 4, 'F');
        
        if (completionRate > 0) {
          doc.setFillColor(...colors.success);
          doc.roundedRect(margin + 20, yPos + 40, progressWidth * completionRate, 8, 4, 4, 'F');
        }

        doc.setFontSize(11);
        doc.setTextColor(...colors.secondary);
        doc.text(`${Math.round(completionRate * 100)}% compl√©t√©`, margin + 20, yPos + 60);

        // Task breakdown
        const taskBreakdown = [
          { label: 'Termin√©es', value: taskStats.done, color: colors.success },
          { label: 'En cours', value: taskStats.inProgress, color: colors.warning },
          { label: '√Ä faire', value: taskStats.todo, color: colors.muted },
          { label: 'Priorit√© haute', value: taskStats.high, color: colors.danger },
          { label: 'En retard', value: taskStats.overdue, color: colors.danger }
        ];

        taskBreakdown.forEach((item, i) => {
          const col = i % 3;
          const row = Math.floor(i / 3);
          const x = margin + 20 + col * 160;
          const y = yPos + 80 + row * 20;
          
          doc.setFillColor(...item.color);
          doc.circle(x, y, 3, 'F');
          
          doc.setFontSize(10);
          doc.setTextColor(...colors.secondary);
          doc.text(`${item.label}: ${item.value}`, x + 10, y + 2);
        });

        yPos += 160;

        // Upcoming tasks
        const upcomingTasks = tasks
          .filter(t => t.status !== 'Termin√©' && t.due)
          .sort((a, b) => new Date(a.due) - new Date(b.due))
          .slice(0, 8);

        if (upcomingTasks.length > 0) {
          doc.setFillColor(...colors.white);
          doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 30 + upcomingTasks.length * 16, 12, 12, 'FD');
          
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.primary);
          doc.text('PROCHAINES √âCH√âANCES', margin + 20, yPos + 25);

          upcomingTasks.forEach((task, i) => {
            const y = yPos + 45 + i * 16;
            const dueDate = new Date(task.due);
            const isOverdue = dueDate < new Date();
            
            // Priority dot
            const priorityColor = task.priority === 'Haute' ? colors.danger : 
                                task.priority === 'Moyenne' ? colors.warning : colors.muted;
            doc.setFillColor(...priorityColor);
            doc.circle(margin + 25, y - 3, 2, 'F');
            
            // Task info
            doc.setFontSize(10);
            doc.setTextColor(isOverdue ? colors.danger : colors.secondary);
            doc.setFont('helvetica', isOverdue ? 'bold' : 'normal');
            
            const taskText = `${task.due} ‚Ä¢ ${task.title}`;
            const assignees = task.assignees && task.assignees.length > 0 ? ` (${task.assignees.join(', ')})` : '';
            
            doc.text(taskText, margin + 35, y);
            doc.setTextColor(...colors.muted);
            doc.setFont('helvetica', 'normal');
            doc.text(assignees, margin + 35 + doc.getTextWidth(taskText), y);
          });
          
          yPos += 20 + upcomingTasks.length * 16 + 40;
        }

        // Check if we need a new page
        if (yPos > pageHeight - 200) {
          doc.addPage();
          yPos = margin;
        }

        // Detailed tables
        if (tasks.length > 0) {
          // Tasks table
          const taskRows = tasks.map(t => [
            t.title,
            t.status,
            t.priority,
            (t.assignees || []).join(', ') || '‚Äî',
            t.due || '‚Äî',
            (t.notes || '').substring(0, 60) + (t.notes && t.notes.length > 60 ? '...' : '')
          ]);

          doc.autoTable({
            startY: yPos,
            head: [['T√¢che', 'Statut', 'Priorit√©', 'Assign√©(s)', '√âch√©ance', 'Notes']],
            body: taskRows,
            styles: {
              fontSize: 9,
              cellPadding: 8,
              lineColor: colors.background,
              lineWidth: 0.5
            },
            headStyles: {
              fillColor: colors.primary,
              textColor: colors.white,
              fontStyle: 'bold',
              fontSize: 10
            },
            alternateRowStyles: {
              fillColor: [250, 250, 252]
            },
            columnStyles: {
              0: { cellWidth: 120 },
              1: { cellWidth: 60, halign: 'center' },
              2: { cellWidth: 60, halign: 'center' },
              3: { cellWidth: 80 },
              4: { cellWidth: 70, halign: 'center' },
              5: { cellWidth: 120 }
            },
            margin: { left: margin, right: margin },
            didParseCell: function(data) {
              if (data.row.index >= 0 && data.column.index === 1) {
                // Status column coloring
                const status = data.cell.raw;
                if (status === 'Termin√©') data.cell.styles.textColor = colors.success;
                else if (status === 'En cours') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
              if (data.row.index >= 0 && data.column.index === 2) {
                // Priority column coloring
                const priority = data.cell.raw;
                if (priority === 'Haute') data.cell.styles.textColor = colors.danger;
                else if (priority === 'Moyenne') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
            }
          });

          yPos = doc.lastAutoTable.finalY + 30;
        }

        // Contacts table
        if (State.data.contacts.length > 0) {
          const contactRows = State.data.contacts.map(c => [
            c.name,
            c.type,
            c.status,
            c.priority,
            c.email || '‚Äî',
            c.social || '‚Äî'
          ]);

          doc.autoTable({
            startY: yPos,
            head: [['Nom', 'Type', 'Statut', 'Priorit√©', 'Email', 'R√©seaux']],
            body: contactRows,
            styles: {
              fontSize: 9,
              cellPadding: 8,
              lineColor: colors.background,
              lineWidth: 0.5
            },
            headStyles: {
              fillColor: colors.secondary,
              textColor: colors.white,
              fontStyle: 'bold',
              fontSize: 10
            },
            alternateRowStyles: {
              fillColor: [250, 250, 252]
            },
            columnStyles: {
              0: { cellWidth: 100 },
              1: { cellWidth: 80, halign: 'center' },
              2: { cellWidth: 80, halign: 'center' },
              3: { cellWidth: 60, halign: 'center' },
              4: { cellWidth: 120 },
              5: { cellWidth: 100 }
            },
            margin: { left: margin, right: margin },
            didParseCell: function(data) {
              if (data.row.index >= 0 && data.column.index === 2) {
                // Status column coloring
                const status = data.cell.raw;
                if (status === 'En contact') data.cell.styles.textColor = colors.success;
                else if (status === '√Ä contacter') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
            }
          });
        }

        // Footer on all pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          
          // Footer line
          doc.setDrawColor(...colors.background);
          doc.line(margin, pageHeight - 40, pageWidth - margin, pageHeight - 40);
          
          // Footer text
          doc.setFontSize(9);
          doc.setTextColor(...colors.muted);
          doc.text(
            `¬© Regards Crois√©s ‚Ä¢ Rapport g√©n√©r√© le ${dateStr}`,
            margin,
            pageHeight - 20
          );
          doc.text(
            `Page ${i}/${pageCount}`,
            pageWidth - margin,
            pageHeight - 20,
            { align: 'right' }
          );
        }

        // Save the PDF
        const filename = `RC-Rapport-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
        doc.save(filename);
        
        toast('üìÑ Rapport PDF export√© avec succ√®s');
      } catch (error) {
        console.error('Erreur PDF:', error);
        toast('‚ùå Erreur lors de l\'export PDF');
      }
    } - 3, 2, 'F');
            
            // Task details
            doc.setFontSize(10);
            doc.setTextColor(isOverdue ? colors.danger : colors.secondary);
            doc.setFont('helvetica', isOverdue ? 'bold' : 'normal');
            
            const taskText = `${task.due} ‚Ä¢ ${task.title.substring(0, 50)}${task.title.length > 50 ? '...' : ''}`;
            const assignees = task.assignees && task.assignees.length > 0 ? ` (${task.assignees.join(', ')})` : '';
            
            doc.text(taskText, margin + 35, y);
            if (assignees) {
              doc.setTextColor(...colors.muted);
              doc.setFont('helvetica', 'normal');
              doc.text(assignees, margin + 35 + doc.getTextWidth(taskText) + 5, y);
            }
          });
          
          yPos += 30 + upcomingTasks.length * 16 + 20;
        }

        // Simple tables without autoTable if it fails
        if (window.jspdfAutoTable && doc.autoTable) {
          // Check if we need a new page
          if (yPos > pageHeight - 200) {
            doc.addPage();
            yPos = margin;
          }

          // Tasks table
          if (tasks.length > 0) {
            const taskRows = tasks.map(t => [
              t.title.substring(0, 30) + (t.title.length > 30 ? '...' : ''),
              t.status,
              t.priority,
              (t.assignees || []).join(', ') || '‚Äî',
              t.due || '‚Äî',
              (t.notes || '').substring(0, 40) + (t.notes && t.notes.length > 40 ? '...' : '')
            ]);

            doc.autoTable({
              startY: yPos,
              head: [['T√¢che', 'Statut', 'Priorit√©', 'Assign√©(s)', '√âch√©ance', 'Notes']],
              body: taskRows,
              styles: {
                fontSize: 9,
                cellPadding: 6,
                lineColor: colors.background,
                lineWidth: 0.5
              },
              headStyles: {
                fillColor: colors.primary,
                textColor: colors.white,
                fontStyle: 'bold',
                fontSize: 10
              },
              alternateRowStyles: {
                fillColor: [250, 250, 252]
              },
              margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 30;
          }

          // Contacts table
          if (State.data.contacts.length > 0) {
            const contactRows = State.data.contacts.map(c => [
              c.name,
              c.type,
              c.status,
              c.priority,
              (c.email || '').substring(0, 25) + (c.email && c.email.length > 25 ? '...' : '') || '‚Äî',
              (c.social || '').substring(0, 20) + (c.social && c.social.length > 20 ? '...' : '') || '‚Äî'
            ]);

            doc.autoTable({
              startY: yPos,
              head: [['Nom', 'Type', 'Statut', 'Priorit√©', 'Email', 'R√©seaux']],
              body: contactRows,
              styles: {
                fontSize: 9,
                cellPadding: 6,
                lineColor: colors.background,
                lineWidth: 0.5
              },
              headStyles: {
                fillColor: colors.secondary,
                textColor: colors.white,
                fontStyle: 'bold',
                fontSize: 10
              },
              alternateRowStyles: {
                fillColor: [250, 250, 252]
              },
              margin: { left: margin, right: margin }
            });
          }
        } else {
          // Fallback: simple text lists if autoTable is not available
          doc.setFontSize(12);
          doc.setTextColor(...colors.primary);
          doc.text('T√ÇCHES', margin, yPos);
          yPos += 20;
          
          tasks.slice(0, 10).forEach((task, i) => {
            doc.setFontSize(10);
            doc.setTextColor(...colors.secondary);
            doc.text(`‚Ä¢ ${task.title} (${task.status})`, margin, yPos + i * 15);
          });
        }

        // Footer on all pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          
          // Footer line
          doc.setDrawColor(...colors.background);
          doc.line(margin, pageHeight - 40, pageWidth - margin, pageHeight - 40);
          
          // Footer text
          doc.setFontSize(9);
          doc.setTextColor(...colors.muted);
          doc.text(
            `¬© Regards Crois√©s ‚Ä¢ Rapport g√©n√©r√© le ${dateStr}`,
            margin,
            pageHeight - 20
          );
          doc.text(
            `Page ${i}/${pageCount}`,
            pageWidth - margin,
            pageHeight - 20,
            { align: 'right' }
          );
        }

        // Save the PDF
        const filename = `RC-Rapport-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
        doc.save(filename);
        
        toast('‚úÖ Rapport PDF export√© avec succ√®s !');
        
      } catch (error) {
        console.error('Erreur PDF:', error);
        toast(`‚ùå Erreur: ${error.message}`);
        
        // Fallback: create a simple text-based report
        createFallbackReport();
      }
    }

    // Helper function to load scripts with better error handling
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Impossible de charger ${src}`));
        script.timeout = 10000; // 10 second timeout
        document.head.appendChild(script);
        
        // Timeout fallback
        setTimeout(() => {
          reject(new Error(`Timeout lors du chargement de ${src}`));
        }, 10000);
      });
    }

    // Fallback report creation
    function createFallbackReport() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('fr-FR');
      const theme = State.data.theme || { title: '', desc: '' };
      
      let report = `REGARDS CROIS√âS - RAPPORT
Date: ${dateStr}

TH√àME DU MOIS
${theme.title || 'Non d√©fini'}
${theme.desc || ''}

VUE D'ENSEMBLE
Articles: ${State.data.articles.length}
√âpisodes: ${State.data.episodes.length}
T√¢ches: ${State.data.tasks.length}
Contacts: ${State.data.contacts.length}

T√ÇCHES
`;

      State.data.tasks.forEach(task => {
        report += `‚Ä¢ ${task.title} (${task.status}) - ${task.priority}\n`;
        if (task.assignees && task.assignees.length) {
          report += `  Assign√©(s): ${task.assignees.join(', ')}\n`;
        }
        if (task.due) {
          report += `  √âch√©ance: ${task.due}\n`;
        }
        report += '\n';
      });

      report += `\nCONTACTS
`;
      State.data.contacts.forEach(contact => {
        report += `‚Ä¢ ${contact.name} (${contact.type}) - ${contact.status}\n`;
        if (contact.email) report += `  Email: ${contact.email}\n`;
        if (contact.social) report += `  R√©seaux: ${contact.social}\n`;
        report += '\n';
      });

      // Create and download as text file
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `RC-Rapport-${dateStr.replace(/\//g, '-')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      toast('üìÑ Rapport texte cr√©√© en remplacement');
    } - 3, 2, 'F');
            
            // Task info
            doc.setFontSize(10);
            doc.setTextColor(isOverdue ? colors.danger : colors.secondary);
            doc.setFont('helvetica', isOverdue ? 'bold' : 'normal');
            
            const taskText = `${task.due} ‚Ä¢ ${task.title}`;
            const assignees = task.assignees && task.assignees.length > 0 ? ` (${task.assignees.join(', ')})` : '';
            
            doc.text(taskText, margin + 35, y);
            doc.setTextColor(...colors.muted);
            doc.setFont('helvetica', 'normal');
            doc.text(assignees, margin + 35 + doc.getTextWidth(taskText), y);
          });
          
          yPos += 20 + upcomingTasks.length * 16 + 40;
        }

        // Check if we need a new page
        if (yPos > pageHeight - 200) {
          doc.addPage();
          yPos = margin;
        }

        // Detailed tables
        if (tasks.length > 0) {
          // Tasks table
          const taskRows = tasks.map(t => [
            t.title,
            t.status,
            t.priority,
            (t.assignees || []).join(', ') || '‚Äî',
            t.due || '‚Äî',
            (t.notes || '').substring(0, 60) + (t.notes && t.notes.length > 60 ? '...' : '')
          ]);

          doc.autoTable({
            startY: yPos,
            head: [['T√¢che', 'Statut', 'Priorit√©', 'Assign√©(s)', '√âch√©ance', 'Notes']],
            body: taskRows,
            styles: {
              fontSize: 9,
              cellPadding: 8,
              lineColor: colors.background,
              lineWidth: 0.5
            },
            headStyles: {
              fillColor: colors.primary,
              textColor: colors.white,
              fontStyle: 'bold',
              fontSize: 10
            },
            alternateRowStyles: {
              fillColor: [250, 250, 252]
            },
            columnStyles: {
              0: { cellWidth: 120 },
              1: { cellWidth: 60, halign: 'center' },
              2: { cellWidth: 60, halign: 'center' },
              3: { cellWidth: 80 },
              4: { cellWidth: 70, halign: 'center' },
              5: { cellWidth: 120 }
            },
            margin: { left: margin, right: margin },
            didParseCell: function(data) {
              if (data.row.index >= 0 && data.column.index === 1) {
                // Status column coloring
                const status = data.cell.raw;
                if (status === 'Termin√©') data.cell.styles.textColor = colors.success;
                else if (status === 'En cours') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
              if (data.row.index >= 0 && data.column.index === 2) {
                // Priority column coloring
                const priority = data.cell.raw;
                if (priority === 'Haute') data.cell.styles.textColor = colors.danger;
                else if (priority === 'Moyenne') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
            }
          });

          yPos = doc.lastAutoTable.finalY + 30;
        }

        // Contacts table
        if (State.data.contacts.length > 0) {
          const contactRows = State.data.contacts.map(c => [
            c.name,
            c.type,
            c.status,
            c.priority,
            c.email || '‚Äî',
            c.social || '‚Äî'
          ]);

          doc.autoTable({
            startY: yPos,
            head: [['Nom', 'Type', 'Statut', 'Priorit√©', 'Email', 'R√©seaux']],
            body: contactRows,
            styles: {
              fontSize: 9,
              cellPadding: 8,
              lineColor: colors.background,
              lineWidth: 0.5
            },
            headStyles: {
              fillColor: colors.secondary,
              textColor: colors.white,
              fontStyle: 'bold',
              fontSize: 10
            },
            alternateRowStyles: {
              fillColor: [250, 250, 252]
            },
            columnStyles: {
              0: { cellWidth: 100 },
              1: { cellWidth: 80, halign: 'center' },
              2: { cellWidth: 80, halign: 'center' },
              3: { cellWidth: 60, halign: 'center' },
              4: { cellWidth: 120 },
              5: { cellWidth: 100 }
            },
            margin: { left: margin, right: margin },
            didParseCell: function(data) {
              if (data.row.index >= 0 && data.column.index === 2) {
                // Status column coloring
                const status = data.cell.raw;
                if (status === 'En contact') data.cell.styles.textColor = colors.success;
                else if (status === '√Ä contacter') data.cell.styles.textColor = colors.warning;
                else data.cell.styles.textColor = colors.muted;
              }
            }
          });
        }

        // Footer on all pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          
          // Footer line
          doc.setDrawColor(...colors.background);
          doc.line(margin, pageHeight - 40, pageWidth - margin, pageHeight - 40);
          
          // Footer text
          doc.setFontSize(9);
          doc.setTextColor(...colors.muted);
          doc.text(
            `¬© Regards Crois√©s ‚Ä¢ Rapport g√©n√©r√© le ${dateStr}`,
            margin,
            pageHeight - 20
          );
          doc.text(
            `Page ${i}/${pageCount}`,
            pageWidth - margin,
            pageHeight - 20,
            { align: 'right' }
          );
        }

        // Save the PDF
        const filename = `RC-Rapport-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
        doc.save(filename);
        
        toast('üìÑ Rapport PDF export√© avec succ√®s');
      } catch (error) {
        console.error('Erreur PDF:', error);
        toast('‚ùå Erreur lors de l\'export PDF');
      }
    }

    // Demo data
    function seedDemo() {
      State.data = {
        theme: {
          title: 'R√©silience ‚Äî Des voix qui s\'√©l√®vent',
          desc: 'Ce mois‚Äëci, r√©silience des civils face aux conflits.'
        },
        team: ['Jude', 'Grace', 'Alex'],
        articles: [{
          id: uid(),
          title: 'Pourquoi ¬´ Regards crois√©s ¬ª ?',
          tags: ['√©ditorial', 'apolitique'],
          summary: 'T√©moignages authentiques, nuance, contre‚Äër√©cit.'
        }],
        episodes: [{
          id: uid(),
          title: '√âpisode 1 ‚Äî Vivre sous le conflit',
          guests: 'journaliste local¬∑e',
          theme: 'Goma (RDC)',
          status: 'Publi√©',
          date: new Date().toISOString().slice(0, 10),
          image: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=400&h=300&fit=crop',
          audio: '',
          link: ''
        }],
        tasks: [
          {
            id: uid(),
            title: 'Contacter journaliste local',
            status: 'En cours',
            priority: 'Haute',
            notes: 'Pitch + cr√©neau',
            assignees: ['Grace'],
            due: new Date(Date.now() + 3 * 86400000).toISOString().slice(0, 10)
          },
          {
            id: uid(),
            title: 'R√©diger article √©ditorial',
            status: '√Ä faire',
            priority: 'Moyenne',
            notes: '',
            assignees: ['Jude'],
            due: new Date(Date.now() + 9 * 86400000).toISOString().slice(0, 10)
          },
          {
            id: uid(),
            title: 'Monter √©pisode 1',
            status: 'Termin√©',
            priority: 'Haute',
            notes: 'Valider compression',
            assignees: ['Grace', 'Alex'],
            completedAt: new Date().toISOString(),
            due: new Date().toISOString().slice(0, 10)
          }
        ],
        contacts: [
          {
            id: uid(),
            name: 'M√©decins du Monde',
            type: 'Organisation',
            status: 'En contact',
            priority: 'Moyenne',
            email: 'contact@medecinsdumonde.org',
            social: '@MDM'
          },
          {
            id: uid(),
            name: 'J. Dupont (Journaliste)',
            type: 'Personnalit√©',
            status: '√Ä contacter',
            priority: 'Haute',
            email: 'j.dupont@example.com',
            social: '@jdupont'
          }
        ]
      };
      State.save();
      renderAll();
      toast('Donn√©es de d√©monstration cr√©√©es');
    }

    // Main render function
    function renderAll() {
      renderArticles();
      renderEpisodes();
      renderTasks();
      renderContacts();
      updateThemePreview();
      refreshAssigneeOptions();
      buildKanban();
      renderTeam();
      updateCounts();
      $('#year').textContent = new Date().getFullYear();
    }

    // Initialization
    function init() {
      try {
        // Apply saved theme
        applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
        $('#btn-theme').onclick = toggleTheme;

        // Load data
        State.load();
        if (!State.data.team || !State.data.team.length) {
          State.data.team = ['Jude', 'Grace'];
        }
        
        // Create demo data if empty
        if (!State.data.articles.length && !State.data.episodes.length && 
            !State.data.tasks.length && !State.data.contacts.length) {
          seedDemo();
        } else {
          renderAll();
        }

        // Tab navigation - THE CRUCIAL PART
        console.log('Setting up tab navigation...');
        document.querySelectorAll('.seg').forEach(btn => {
          console.log('Adding listener to button:', btn.dataset.tab);
          btn.onclick = () => {
            console.log('Tab clicked:', btn.dataset.tab);
            selectTab(btn.dataset.tab);
          };
        });

        // Test if selectTab function works
        console.log('Testing selectTab function...');
        if (typeof selectTab === 'function') {
          console.log('selectTab function is available');
        } else {
          console.error('selectTab function is NOT available');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === '/') {
            e.preventDefault();
            const tab = document.querySelector('.seg[aria-selected="true"]')?.dataset?.tab;
            if (tab) {
              const field = document.querySelector(`#tab-${tab} input[placeholder*="Recherche"]`);
              if (field) field.focus();
            }
          }
          if (e.key.toLowerCase() === 't') {
            selectTab('tasks');
            setTimeout(() => {
              const taskTitle = $('#task-title');
              if (taskTitle) taskTitle.focus();
            }, 100);
          }
        });

        // Team management
        const addTeam = (selector) => {
          const input = document.querySelector(selector);
          if (!input) return;
          const name = input.value.trim();
          if (!name) return;
          if (State.data.team.includes(name)) {
            toast('Ce membre existe d√©j√†');
            return;
          }
          State.data.team.push(name);
          State.save();
          input.value = '';
          renderTeam();
          refreshAssigneeOptions();
          updateCounts();
          toast(`${name} ajout√© √† l'√©quipe`);
        };

        const teamAddMain = $('#team-add-main');
        const teamAdd = $('#team-add');
        if (teamAddMain) teamAddMain.onclick = () => addTeam('#team-input');
        if (teamAdd) teamAdd.onclick = () => addTeam('#team-new');

      // Form submissions
      $('#article-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const id = $('#article-id').value || uid();
        const entry = {
          id,
          title: $('#article-title').value.trim(),
          tags: stringifyTags($('#article-tags').value),
          summary: $('#article-summary').value.trim()
        };
        
        if (!entry.title) {
          toast('Titre requis');
          return;
        }
        
        const idx = State.data.articles.findIndex(a => a.id === id);
        if (idx > -1) {
          State.data.articles[idx] = entry;
        } else {
          State.data.articles.unshift(entry);
        }
        
        State.save();
        e.target.reset();
        $('#article-id').value = '';
        renderArticles();
        updateCounts();
        toast('Article enregistr√©');
      });

      $('#ep-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const id = $('#ep-id').value || uid();
        const entry = {
          id,
          title: $('#ep-title').value.trim(),
          guests: $('#ep-guests').value.trim(),
          theme: $('#ep-theme').value.trim(),
          image: $('#ep-image').value.trim(),
          audio: $('#ep-audio').value.trim(),
          link: $('#ep-link').value.trim(),
          status: $('#ep-status').value,
          date: $('#ep-date').value
        };
        
        if (!entry.title) {
          toast('Titre requis');
          return;
        }
        
        const idx = State.data.episodes.findIndex(a => a.id === id);
        if (idx > -1) {
          State.data.episodes[idx] = entry;
        } else {
          State.data.episodes.unshift(entry);
        }
        
        State.save();
        e.target.reset();
        $('#ep-id').value = '';
        renderEpisodes();
        updateCounts();
        toast('√âpisode enregistr√©');
      });

      $('#task-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const id = $('#task-id').value || uid();
        const assignees = Array.from($('#task-assignees').selectedOptions).map(o => o.value);
        const entry = {
          id,
          title: $('#task-title').value.trim(),
          status: $('#task-status').value,
          priority: $('#task-priority').value,
          notes: $('#task-notes').value.trim(),
          assignees,
          due: $('#task-due').value
        };
        
        if (!entry.title) {
          toast('Titre requis');
          return;
        }
        
        const idx = State.data.tasks.findIndex(a => a.id === id);
        if (idx > -1) {
          const prev = State.data.tasks[idx];
          if (entry.status === 'Termin√©' && prev.status !== 'Termin√©' && !prev.completedAt) {
            entry.completedAt = new Date().toISOString();
          }
          if (prev.completedAt && entry.status === 'Termin√©') {
            entry.completedAt = prev.completedAt;
          }
          State.data.tasks[idx] = entry;
        } else {
          if (entry.status === 'Termin√©') {
            entry.completedAt = new Date().toISOString();
          }
          State.data.tasks.unshift(entry);
        }
        
        State.save();
        e.target.reset();
        $('#task-id').value = '';
        renderTasks();
        buildKanban();
        updateCounts();
        toast('T√¢che enregistr√©e');
      });

      $('#contact-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const id = $('#contact-id').value || uid();
        const entry = {
          id,
          name: $('#contact-name').value.trim(),
          type: $('#contact-type').value,
          status: $('#contact-status').value,
          priority: $('#contact-priority').value,
          email: $('#contact-email').value.trim(),
          social: $('#contact-social').value.trim()
        };
        
        if (!entry.name) {
          toast('Nom requis');
          return;
        }
        
        const idx = State.data.contacts.findIndex(a => a.id === id);
        if (idx > -1) {
          State.data.contacts[idx] = entry;
        } else {
          State.data.contacts.unshift(entry);
        }
        
        State.save();
        e.target.reset();
        $('#contact-id').value = '';
        renderContacts();
        updateCounts();
        toast('Contact enregistr√©');
      });

      $('#theme-form').addEventListener('submit', e => {
        e.preventDefault();
        State.data.theme = {
          title: $('#theme-title').value.trim(),
          desc: $('#theme-desc').value.trim()
        };
        State.save();
        updateThemePreview();
        toast('Th√®me mis √† jour');
      });

      // Reset buttons
      $('#article-reset').onclick = () => {
        $('#article-form').reset();
        $('#article-id').value = '';
      };
      $('#ep-reset').onclick = () => {
        $('#ep-form').reset();
        $('#ep-id').value = '';
      };
      $('#task-reset').onclick = () => {
        $('#task-form').reset();
        $('#task-id').value = '';
      };
      $('#contact-reset').onclick = () => {
        $('#contact-form').reset();
        $('#contact-id').value = '';
      };

      // Search handlers
      $('#article-search').oninput = () => renderArticles();
      $('#ep-search').oninput = () => renderEpisodes();
      $('#task-search').oninput = () => renderTasks();
      $('#contact-search').oninput = () => renderContacts();
      $('#task-sort').onchange = () => renderTasks();

      // Clear buttons
      $('#article-clear').onclick = () => {
        if (confirm('Supprimer tous les articles ?')) {
          State.data.articles = [];
          State.save();
          renderArticles();
          updateCounts();
          toast('Articles supprim√©s');
        }
      };
      $('#ep-clear').onclick = () => {
        if (confirm('Supprimer tous les √©pisodes ?')) {
          State.data.episodes = [];
          State.save();
          renderEpisodes();
          updateCounts();
          toast('√âpisodes supprim√©s');
        }
      };
      $('#task-clear').onclick = () => {
        if (confirm('Supprimer toutes les t√¢ches ?')) {
          State.data.tasks = [];
          State.save();
          renderTasks();
          buildKanban();
          updateCounts();
          toast('T√¢ches supprim√©es');
        }
      };
      $('#contact-clear').onclick = () => {
        if (confirm('Supprimer tous les contacts ?')) {
          State.data.contacts = [];
          State.save();
          renderContacts();
          updateCounts();
          toast('Contacts supprim√©s');
        }
      };

      // View toggle buttons
      $('#view-list').onclick = () => {
        $('#task-list').classList.remove('hidden');
        $('#task-kanban').classList.add('hidden');
        $('#view-list').style.background = 'var(--accent)';
        $('#view-list').style.color = 'white';
        $('#view-kanban').style.background = '';
        $('#view-kanban').style.color = '';
      };
      $('#view-kanban').onclick = () => {
        $('#task-kanban').classList.remove('hidden');
        $('#task-list').classList.add('hidden');
        $('#view-kanban').style.background = 'var(--accent)';
        $('#view-kanban').style.color = 'white';
        $('#view-list').style.background = '';
        $('#view-list').style.color = '';
        buildKanban();
      };

      // Admin functions
      $('#btn-pdf').onclick = exportPDF;
      $('#btn-reset').onclick = () => {
        if (confirm('Tout r√©initialiser ? Cette action est irr√©versible.')) {
          localStorage.removeItem(KEY);
          State.load();
          renderAll();
          toast('Application r√©initialis√©e');
        }
      };
      $('#btn-demo').onclick = () => {
        if (confirm('√âcraser les donn√©es actuelles par une d√©mo ?')) {
          seedDemo();
        }
      };
    }

    // PWA Installation
    let deferredPrompt;
    const installBtn = $('#btn-install');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.log('SW registration failed');
        });
      });
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
  </script>
</body>
</html>
